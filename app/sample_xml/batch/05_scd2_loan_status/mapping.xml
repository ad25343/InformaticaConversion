<?xml version="1.0" encoding="UTF-8"?>
<!--
  ============================================================================
  INFORMATICA POWERCENTER MAPPING XML EXPORT
  ============================================================================
  Mapping Name: m_LOAN_STATUS_SCD2
  Project: Mortgage Loan E2E Batch Processing
  Stage: 5 of 6 - Slowly Changing Dimension Type 2 (SCD2) Implementation
  Complexity Level: HIGH
  
  PURPOSE:
  --------
  Implements SCD Type 2 on the DIM_LOAN_STATUS dimension table. This mapping:
  - Reads daily loan status updates from the Oracle operational system
  - Performs a full outer join between new updates and current dimension records
  - Detects new records and changed records via expression logic
  - Generates surrogate keys using a Sequence Generator
  - Sets SCD2 effective/expiry dates (new=today, expires old=yesterday)
  - Marks records as current (IS_CURRENT='Y') when inserted
  - Expires old current records by updating their IS_CURRENT='N' and EXPIRY_DATE
  
  This is the most complex mapping in the batch set due to:
  1. Full outer join for detecting both new and changed records
  2. Complex expression logic for SCD2 rules
  3. Sequence generator for surrogate keys
  4. Update strategy to handle both inserts and updates
  5. Multi-source qualification and filtering
  
  SOURCES:
  --------
  1. LOAN_STATUS_UPDATES (Oracle operational DB)
     - Fields: APPLICATION_ID, LOAN_STATUS, STATUS_DATE, STATUS_REASON, 
               SERVICER_ID, NEXT_PAYMENT_DATE, OUTSTANDING_BALANCE, DAYS_PAST_DUE
     - Daily operational updates filtered by load date
  
  2. DIM_LOAN_STATUS (Snowflake dimension)
     - Current records only (IS_CURRENT='Y')
     - Used to detect changes and generate expiry records
  
  TARGET:
  -------
  DIM_LOAN_STATUS (Snowflake target)
     - Receives both new dimension records and expiry records
  
  TRANSFORMATION FLOW:
  --------------------
  1. SQ_LOAN_STATUS_UPDATES → Source Qualifier from Oracle (filtered by $$LOAD_DATE)
  2. SQ_DIM_LOAN_STATUS_CURRENT → Source Qualifier from Snowflake (SQL override for current only)
  3. JNR_DETECT_CHANGES → Full Outer Join on APPLICATION_ID
  4. EXP_DETECT_CHANGES → Expression logic for SCD2 detection
  5. FIL_NEEDS_SCD2 → Filter for records that need SCD2 processing
  6. SEQ_LOAN_STATUS_KEY → Sequence Generator for surrogate keys
  7. EXP_SET_SCD2_FIELDS → Expression to finalize all SCD2 fields
  8. UPD_SCD2_STRATEGY → Update Strategy for insert/update routing
  9. TGT_DIM_LOAN_STATUS → Target Snowflake table
  
  RUNTIME VARIABLES:
  ------------------
  $$SRC_CONNECTION = Oracle operational connection
  $$DIM_CONNECTION = Snowflake dimension connection
  $$TGT_CONNECTION = Snowflake target connection
  $$LOAD_DATE = Current batch load date (YYYY-MM-DD format)
  $$REJECT_FILE_DIR = Directory for bad record files
  $$ENV = Environment (DEV/UAT/PROD)
  
  COMPLEX SCD2 LOGIC:
  -------------------
  The mapping handles both inserts and updates:
  - NEW records: No match on APPLICATION_ID in current dimension
  - CHANGED records: Match exists but LOAN_STATUS value differs
  - Both route through Update Strategy as DD_INSERT for new dimension rows
  - Old current records are expired via DD_UPDATE with new EXPIRY_DATE
  
  Expected Records per Load:
  - New applications: ~200-500 inserts
  - Status changes: ~500-1000 insert + update pairs
  - Unchanged records: Filtered out (no processing)
  
  Author: Cloud Data Engineering Team
  Created: 2026-03-01
  Last Modified: 2026-03-01
  Version: 1.0
  ============================================================================
-->
<MAPPING NAME="m_LOAN_STATUS_SCD2" DESCRIPTION="SCD Type 2 - Loan Status Dimension">
  <!-- ===================================================================== -->
  <!-- METADATA OBJECTS AND FOLDER REFERENCE                                -->
  <!-- ===================================================================== -->
  <METAINFO>
    <MAPPING_VERSION>2022.1.0</MAPPING_VERSION>
    <CREATED_DATE>2026-03-01</CREATED_DATE>
    <CREATED_BY>CloudEngineering</CREATED_BY>
    <MODIFIED_DATE>2026-03-01</MODIFIED_DATE>
    <MODIFIED_BY>CloudEngineering</MODIFIED_BY>
    <PROJECT_CODE>MortgageLoanE2E</PROJECT_CODE>
    <BATCH_STAGE>5_SCD2_Implementation</BATCH_STAGE>
    <COMPLEXITY_LEVEL>HIGH</COMPLEXITY_LEVEL>
    <TECHNOLOGY_STACK>PySpark, Informatica, Snowflake, Oracle</TECHNOLOGY_STACK>
  </METAINFO>

  <!-- ===================================================================== -->
  <!-- SOURCE DEFINITIONS                                                    -->
  <!-- ===================================================================== -->
  <SOURCE NAME="LOAN_STATUS_UPDATES" SOURCECONNECTION="$$SRC_CONNECTION" 
           SOURCETYPE="RelationalSource" DATABASETYPE="Oracle">
    <DESCRIPTION>Oracle operational system - daily loan status updates</DESCRIPTION>
    <TABLENAME>LOAN_STATUS_UPDATES</TABLENAME>
    <SOURCEFIELD NAME="APPLICATION_ID" DATATYPE="BIGINT" PRECISION="19" SCALE="0" />
    <SOURCEFIELD NAME="LOAN_STATUS" DATATYPE="STRING" PRECISION="30" SCALE="0" />
    <SOURCEFIELD NAME="STATUS_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" />
    <SOURCEFIELD NAME="STATUS_REASON" DATATYPE="STRING" PRECISION="500" SCALE="0" />
    <SOURCEFIELD NAME="SERVICER_ID" DATATYPE="BIGINT" PRECISION="19" SCALE="0" />
    <SOURCEFIELD NAME="NEXT_PAYMENT_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" />
    <SOURCEFIELD NAME="OUTSTANDING_BALANCE" DATATYPE="DECIMAL" PRECISION="18" SCALE="2" />
    <SOURCEFIELD NAME="DAYS_PAST_DUE" DATATYPE="INTEGER" PRECISION="10" SCALE="0" />
  </SOURCE>

  <SOURCE NAME="DIM_LOAN_STATUS" SOURCECONNECTION="$$DIM_CONNECTION" 
           SOURCETYPE="RelationalSource" DATABASETYPE="Snowflake">
    <DESCRIPTION>Snowflake dimension - current loan status records</DESCRIPTION>
    <TABLENAME>DIM_LOAN_STATUS</TABLENAME>
    <SOURCEFIELD NAME="LOAN_STATUS_KEY" DATATYPE="BIGINT" PRECISION="19" SCALE="0" />
    <SOURCEFIELD NAME="APPLICATION_ID" DATATYPE="BIGINT" PRECISION="19" SCALE="0" />
    <SOURCEFIELD NAME="LOAN_STATUS" DATATYPE="STRING" PRECISION="30" SCALE="0" />
    <SOURCEFIELD NAME="STATUS_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" />
    <SOURCEFIELD NAME="STATUS_REASON" DATATYPE="STRING" PRECISION="500" SCALE="0" />
    <SOURCEFIELD NAME="SERVICER_ID" DATATYPE="BIGINT" PRECISION="19" SCALE="0" />
    <SOURCEFIELD NAME="NEXT_PAYMENT_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" />
    <SOURCEFIELD NAME="OUTSTANDING_BALANCE" DATATYPE="DECIMAL" PRECISION="18" SCALE="2" />
    <SOURCEFIELD NAME="DAYS_PAST_DUE" DATATYPE="INTEGER" PRECISION="10" SCALE="0" />
    <SOURCEFIELD NAME="EFFECTIVE_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" />
    <SOURCEFIELD NAME="EXPIRY_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" />
    <SOURCEFIELD NAME="IS_CURRENT" DATATYPE="STRING" PRECISION="1" SCALE="0" />
    <SOURCEFIELD NAME="CREATED_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" />
  </SOURCE>

  <!-- ===================================================================== -->
  <!-- SOURCE QUALIFIER 1: LOAN_STATUS_UPDATES (filtered by load date)       -->
  <!-- ===================================================================== -->
  <TRANSFORMATION NAME="SQ_LOAN_STATUS_UPDATES" TRANSFORMTYPE="Source Qualifier">
    <DESCRIPTION>Source Qualifier - Oracle LOAN_STATUS_UPDATES filtered by $$LOAD_DATE</DESCRIPTION>
    <PROPERTY NAME="SOURCE" VALUE="LOAN_STATUS_UPDATES" />
    <PROPERTY NAME="SQL_OVERRIDE" VALUE="SELECT APPLICATION_ID, LOAN_STATUS, STATUS_DATE, STATUS_REASON, SERVICER_ID, NEXT_PAYMENT_DATE, OUTSTANDING_BALANCE, DAYS_PAST_DUE FROM LOAN_STATUS_UPDATES WHERE TRUNC(STATUS_DATE) = TRUNC(TO_DATE('$$LOAD_DATE','YYYY-MM-DD'))" />
    <PROPERTY NAME="QUERY_OPTIMIZATION" VALUE="YES" />
    <PROPERTY NAME="CACHING_OPTION" VALUE="NO" />
    
    <TRANSFORMFIELD NAME="APPLICATION_ID" DATATYPE="BIGINT" PRECISION="19" SCALE="0" DESCRIPTION="Application identifier from source" />
    <TRANSFORMFIELD NAME="LOAN_STATUS" DATATYPE="STRING" PRECISION="30" SCALE="0" DESCRIPTION="Current loan status code" />
    <TRANSFORMFIELD NAME="STATUS_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="Date of status change" />
    <TRANSFORMFIELD NAME="STATUS_REASON" DATATYPE="STRING" PRECISION="500" SCALE="0" DESCRIPTION="Reason for status change" />
    <TRANSFORMFIELD NAME="SERVICER_ID" DATATYPE="BIGINT" PRECISION="19" SCALE="0" DESCRIPTION="Loan servicer identifier" />
    <TRANSFORMFIELD NAME="NEXT_PAYMENT_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="Next payment due date" />
    <TRANSFORMFIELD NAME="OUTSTANDING_BALANCE" DATATYPE="DECIMAL" PRECISION="18" SCALE="2" DESCRIPTION="Current outstanding loan balance" />
    <TRANSFORMFIELD NAME="DAYS_PAST_DUE" DATATYPE="INTEGER" PRECISION="10" SCALE="0" DESCRIPTION="Number of days past due" />
  </TRANSFORMATION>

  <!-- ===================================================================== -->
  <!-- SOURCE QUALIFIER 2: DIM_LOAN_STATUS current records (SQL override)   -->
  <!-- ===================================================================== -->
  <TRANSFORMATION NAME="SQ_DIM_LOAN_STATUS_CURRENT" TRANSFORMTYPE="Source Qualifier">
    <DESCRIPTION>Source Qualifier - Snowflake DIM_LOAN_STATUS with SQL override for IS_CURRENT='Y'</DESCRIPTION>
    <PROPERTY NAME="SOURCE" VALUE="DIM_LOAN_STATUS" />
    <PROPERTY NAME="SQL_OVERRIDE" VALUE="SELECT LOAN_STATUS_KEY, APPLICATION_ID, LOAN_STATUS, STATUS_DATE, STATUS_REASON, SERVICER_ID, NEXT_PAYMENT_DATE, OUTSTANDING_BALANCE, DAYS_PAST_DUE, EFFECTIVE_DATE, EXPIRY_DATE, IS_CURRENT, CREATED_DATE FROM DIM_LOAN_STATUS WHERE IS_CURRENT = 'Y'" />
    <PROPERTY NAME="QUERY_OPTIMIZATION" VALUE="YES" />
    <PROPERTY NAME="CACHING_OPTION" VALUE="YES" />
    <PROPERTY NAME="CACHE_TYPE" VALUE="LOOKUP" />
    
    <TRANSFORMFIELD NAME="LOAN_STATUS_KEY" DATATYPE="BIGINT" PRECISION="19" SCALE="0" DESCRIPTION="Surrogate key from dimension" />
    <TRANSFORMFIELD NAME="APPLICATION_ID" DATATYPE="BIGINT" PRECISION="19" SCALE="0" DESCRIPTION="Application identifier" />
    <TRANSFORMFIELD NAME="LOAN_STATUS" DATATYPE="STRING" PRECISION="30" SCALE="0" DESCRIPTION="Loan status from dimension" />
    <TRANSFORMFIELD NAME="STATUS_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="Status date from dimension" />
    <TRANSFORMFIELD NAME="STATUS_REASON" DATATYPE="STRING" PRECISION="500" SCALE="0" DESCRIPTION="Status reason from dimension" />
    <TRANSFORMFIELD NAME="SERVICER_ID" DATATYPE="BIGINT" PRECISION="19" SCALE="0" DESCRIPTION="Servicer ID from dimension" />
    <TRANSFORMFIELD NAME="NEXT_PAYMENT_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="Next payment date from dimension" />
    <TRANSFORMFIELD NAME="OUTSTANDING_BALANCE" DATATYPE="DECIMAL" PRECISION="18" SCALE="2" DESCRIPTION="Balance from dimension" />
    <TRANSFORMFIELD NAME="DAYS_PAST_DUE" DATATYPE="INTEGER" PRECISION="10" SCALE="0" DESCRIPTION="Days past due from dimension" />
    <TRANSFORMFIELD NAME="EFFECTIVE_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="SCD2 effective date" />
    <TRANSFORMFIELD NAME="EXPIRY_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="SCD2 expiry date" />
    <TRANSFORMFIELD NAME="IS_CURRENT" DATATYPE="STRING" PRECISION="1" SCALE="0" DESCRIPTION="Current flag" />
    <TRANSFORMFIELD NAME="CREATED_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="Record creation date" />
  </TRANSFORMATION>

  <!-- ===================================================================== -->
  <!-- JOINER: Full Outer Join on APPLICATION_ID                            -->
  <!-- Master: Current Dimension Records (SQ_DIM_LOAN_STATUS_CURRENT)        -->
  <!-- Detail: New Updates (SQ_LOAN_STATUS_UPDATES)                          -->
  <!-- ===================================================================== -->
  <TRANSFORMATION NAME="JNR_DETECT_CHANGES" TRANSFORMTYPE="Joiner">
    <DESCRIPTION>Full Outer Join - Detects new records (null in dimension) and changed records (status differs)</DESCRIPTION>
    <PROPERTY NAME="JOINTYPE" VALUE="FULL_OUTER" />
    <PROPERTY NAME="MASTER_SOURCE" VALUE="SQ_DIM_LOAN_STATUS_CURRENT" />
    <PROPERTY NAME="DETAIL_SOURCE" VALUE="SQ_LOAN_STATUS_UPDATES" />
    <PROPERTY NAME="SORT_INPUT" VALUE="YES" />
    <PROPERTY NAME="CACHE_LOOKUP" VALUE="YES" />
    
    <!-- Join condition on APPLICATION_ID -->
    <JOINCONDITION>
      <CONDITION MASTERFIELD="APPLICATION_ID" DETAILFIELD="APPLICATION_ID" OPERATOR="=" />
    </JOINCONDITION>
    
    <!-- Master fields (from dimension) -->
    <TRANSFORMFIELD NAME="DIM_LOAN_STATUS_KEY" DATATYPE="BIGINT" PRECISION="19" SCALE="0" DESCRIPTION="Dimension surrogate key (may be null for new)" />
    <TRANSFORMFIELD NAME="DIM_APPLICATION_ID" DATATYPE="BIGINT" PRECISION="19" SCALE="0" DESCRIPTION="Dimension application ID" />
    <TRANSFORMFIELD NAME="DIM_LOAN_STATUS" DATATYPE="STRING" PRECISION="30" SCALE="0" DESCRIPTION="Status from dimension" />
    <TRANSFORMFIELD NAME="DIM_STATUS_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="Status date from dimension" />
    <TRANSFORMFIELD NAME="DIM_STATUS_REASON" DATATYPE="STRING" PRECISION="500" SCALE="0" DESCRIPTION="Status reason from dimension" />
    <TRANSFORMFIELD NAME="DIM_SERVICER_ID" DATATYPE="BIGINT" PRECISION="19" SCALE="0" DESCRIPTION="Servicer ID from dimension" />
    <TRANSFORMFIELD NAME="DIM_NEXT_PAYMENT_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="Next payment date from dimension" />
    <TRANSFORMFIELD NAME="DIM_OUTSTANDING_BALANCE" DATATYPE="DECIMAL" PRECISION="18" SCALE="2" DESCRIPTION="Balance from dimension" />
    <TRANSFORMFIELD NAME="DIM_DAYS_PAST_DUE" DATATYPE="INTEGER" PRECISION="10" SCALE="0" DESCRIPTION="Days past due from dimension" />
    <TRANSFORMFIELD NAME="DIM_EFFECTIVE_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="Effective date from dimension" />
    <TRANSFORMFIELD NAME="DIM_EXPIRY_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="Expiry date from dimension" />
    
    <!-- Detail fields (from source) -->
    <TRANSFORMFIELD NAME="SRC_APPLICATION_ID" DATATYPE="BIGINT" PRECISION="19" SCALE="0" DESCRIPTION="Application ID from source" />
    <TRANSFORMFIELD NAME="SRC_LOAN_STATUS" DATATYPE="STRING" PRECISION="30" SCALE="0" DESCRIPTION="Loan status from source" />
    <TRANSFORMFIELD NAME="SRC_STATUS_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="Status date from source" />
    <TRANSFORMFIELD NAME="SRC_STATUS_REASON" DATATYPE="STRING" PRECISION="500" SCALE="0" DESCRIPTION="Status reason from source" />
    <TRANSFORMFIELD NAME="SRC_SERVICER_ID" DATATYPE="BIGINT" PRECISION="19" SCALE="0" DESCRIPTION="Servicer ID from source" />
    <TRANSFORMFIELD NAME="SRC_NEXT_PAYMENT_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="Next payment date from source" />
    <TRANSFORMFIELD NAME="SRC_OUTSTANDING_BALANCE" DATATYPE="DECIMAL" PRECISION="18" SCALE="2" DESCRIPTION="Balance from source" />
    <TRANSFORMFIELD NAME="SRC_DAYS_PAST_DUE" DATATYPE="INTEGER" PRECISION="10" SCALE="0" DESCRIPTION="Days past due from source" />
  </TRANSFORMATION>

  <!-- ===================================================================== -->
  <!-- EXPRESSION: Detect Changes and Set SCD2 Indicators                    -->
  <!-- Complex logic for determining new records, changed records, and       -->
  <!-- generating appropriate SCD2 fields                                    -->
  <!-- ===================================================================== -->
  <TRANSFORMATION NAME="EXP_DETECT_CHANGES" TRANSFORMTYPE="Expression">
    <DESCRIPTION>Complex SCD2 detection logic - identifies new records, changed records, and prepares SCD2 fields</DESCRIPTION>
    
    <!-- Input ports (passed through from joiner) -->
    <TRANSFORMFIELD NAME="DIM_LOAN_STATUS_KEY" DATATYPE="BIGINT" PRECISION="19" SCALE="0" DESCRIPTION="Input: dimension key" />
    <TRANSFORMFIELD NAME="DIM_APPLICATION_ID" DATATYPE="BIGINT" PRECISION="19" SCALE="0" DESCRIPTION="Input: dimension app ID" />
    <TRANSFORMFIELD NAME="DIM_LOAN_STATUS" DATATYPE="STRING" PRECISION="30" SCALE="0" DESCRIPTION="Input: dimension status" />
    <TRANSFORMFIELD NAME="DIM_STATUS_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="Input: dimension status date" />
    <TRANSFORMFIELD NAME="DIM_STATUS_REASON" DATATYPE="STRING" PRECISION="500" SCALE="0" DESCRIPTION="Input: dimension reason" />
    <TRANSFORMFIELD NAME="DIM_SERVICER_ID" DATATYPE="BIGINT" PRECISION="19" SCALE="0" DESCRIPTION="Input: dimension servicer" />
    <TRANSFORMFIELD NAME="DIM_NEXT_PAYMENT_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="Input: dimension next payment" />
    <TRANSFORMFIELD NAME="DIM_OUTSTANDING_BALANCE" DATATYPE="DECIMAL" PRECISION="18" SCALE="2" DESCRIPTION="Input: dimension balance" />
    <TRANSFORMFIELD NAME="DIM_DAYS_PAST_DUE" DATATYPE="INTEGER" PRECISION="10" SCALE="0" DESCRIPTION="Input: dimension days past due" />
    <TRANSFORMFIELD NAME="DIM_EFFECTIVE_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="Input: dimension effective date" />
    <TRANSFORMFIELD NAME="SRC_APPLICATION_ID" DATATYPE="BIGINT" PRECISION="19" SCALE="0" DESCRIPTION="Input: source app ID" />
    <TRANSFORMFIELD NAME="SRC_LOAN_STATUS" DATATYPE="STRING" PRECISION="30" SCALE="0" DESCRIPTION="Input: source status" />
    <TRANSFORMFIELD NAME="SRC_STATUS_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="Input: source status date" />
    <TRANSFORMFIELD NAME="SRC_STATUS_REASON" DATATYPE="STRING" PRECISION="500" SCALE="0" DESCRIPTION="Input: source reason" />
    <TRANSFORMFIELD NAME="SRC_SERVICER_ID" DATATYPE="BIGINT" PRECISION="19" SCALE="0" DESCRIPTION="Input: source servicer" />
    <TRANSFORMFIELD NAME="SRC_NEXT_PAYMENT_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="Input: source next payment" />
    <TRANSFORMFIELD NAME="SRC_OUTSTANDING_BALANCE" DATATYPE="DECIMAL" PRECISION="18" SCALE="2" DESCRIPTION="Input: source balance" />
    <TRANSFORMFIELD NAME="SRC_DAYS_PAST_DUE" DATATYPE="INTEGER" PRECISION="10" SCALE="0" DESCRIPTION="Input: source days past due" />

    <!-- Derivation: IS_NEW flag - true if record not in current dimension -->
    <TRANSFORMFIELD NAME="IS_NEW" DATATYPE="STRING" PRECISION="1" SCALE="0" DESCRIPTION="Output: Y/N - is this a new application">
      <EXPRESSION>IIF(ISNULL(DIM_LOAN_STATUS_KEY), 'Y', 'N')</EXPRESSION>
    </TRANSFORMFIELD>

    <!-- Derivation: STATUS_CHANGED flag - true if status differs from current -->
    <TRANSFORMFIELD NAME="STATUS_CHANGED" DATATYPE="STRING" PRECISION="1" SCALE="0" DESCRIPTION="Output: Y/N - has status changed">
      <EXPRESSION>IIF(IS_NEW='N' AND UPPER(SRC_LOAN_STATUS) != UPPER(DIM_LOAN_STATUS), 'Y', 'N')</EXPRESSION>
    </TRANSFORMFIELD>

    <!-- Derivation: NEEDS_SCD2 - flag for whether this record needs processing -->
    <TRANSFORMFIELD NAME="NEEDS_SCD2" DATATYPE="STRING" PRECISION="1" SCALE="0" DESCRIPTION="Output: Y/N - needs SCD2 processing">
      <EXPRESSION>IIF(IS_NEW='Y' OR STATUS_CHANGED='Y', 'Y', 'N')</EXPRESSION>
    </TRANSFORMFIELD>

    <!-- Derivation: Use source or dimension APPLICATION_ID as appropriate -->
    <TRANSFORMFIELD NAME="NEW_APPLICATION_ID" DATATYPE="BIGINT" PRECISION="19" SCALE="0" DESCRIPTION="Output: final APPLICATION_ID to use">
      <EXPRESSION>IIF(IS_NEW='Y', SRC_APPLICATION_ID, DIM_APPLICATION_ID)</EXPRESSION>
    </TRANSFORMFIELD>

    <!-- Derivation: Set new or changed status to source, else dimension -->
    <TRANSFORMFIELD NAME="NEW_LOAN_STATUS" DATATYPE="STRING" PRECISION="30" SCALE="0" DESCRIPTION="Output: LOAN_STATUS for new record">
      <EXPRESSION>IIF(IS_NEW='Y' OR STATUS_CHANGED='Y', SRC_LOAN_STATUS, DIM_LOAN_STATUS)</EXPRESSION>
    </TRANSFORMFIELD>

    <!-- Derivation: New records use source data, unchanged use dimension -->
    <TRANSFORMFIELD NAME="NEW_STATUS_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="Output: STATUS_DATE for new record">
      <EXPRESSION>IIF(IS_NEW='Y' OR STATUS_CHANGED='Y', SRC_STATUS_DATE, DIM_STATUS_DATE)</EXPRESSION>
    </TRANSFORMFIELD>

    <TRANSFORMFIELD NAME="NEW_STATUS_REASON" DATATYPE="STRING" PRECISION="500" SCALE="0" DESCRIPTION="Output: STATUS_REASON for new record">
      <EXPRESSION>IIF(IS_NEW='Y' OR STATUS_CHANGED='Y', SRC_STATUS_REASON, DIM_STATUS_REASON)</EXPRESSION>
    </TRANSFORMFIELD>

    <TRANSFORMFIELD NAME="NEW_SERVICER_ID" DATATYPE="BIGINT" PRECISION="19" SCALE="0" DESCRIPTION="Output: SERVICER_ID for new record">
      <EXPRESSION>IIF(IS_NEW='Y' OR STATUS_CHANGED='Y', SRC_SERVICER_ID, DIM_SERVICER_ID)</EXPRESSION>
    </TRANSFORMFIELD>

    <TRANSFORMFIELD NAME="NEW_NEXT_PAYMENT_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="Output: NEXT_PAYMENT_DATE for new record">
      <EXPRESSION>IIF(IS_NEW='Y' OR STATUS_CHANGED='Y', SRC_NEXT_PAYMENT_DATE, DIM_NEXT_PAYMENT_DATE)</EXPRESSION>
    </TRANSFORMFIELD>

    <TRANSFORMFIELD NAME="NEW_OUTSTANDING_BALANCE" DATATYPE="DECIMAL" PRECISION="18" SCALE="2" DESCRIPTION="Output: OUTSTANDING_BALANCE for new record">
      <EXPRESSION>IIF(IS_NEW='Y' OR STATUS_CHANGED='Y', SRC_OUTSTANDING_BALANCE, DIM_OUTSTANDING_BALANCE)</EXPRESSION>
    </TRANSFORMFIELD>

    <TRANSFORMFIELD NAME="NEW_DAYS_PAST_DUE" DATATYPE="INTEGER" PRECISION="10" SCALE="0" DESCRIPTION="Output: DAYS_PAST_DUE for new record">
      <EXPRESSION>IIF(IS_NEW='Y' OR STATUS_CHANGED='Y', SRC_DAYS_PAST_DUE, DIM_DAYS_PAST_DUE)</EXPRESSION>
    </TRANSFORMFIELD>

    <!-- Derivation: SCD2 effective date - set to load date for new/changed -->
    <TRANSFORMFIELD NAME="NEW_EFFECTIVE_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="Output: SCD2 EFFECTIVE_DATE">
      <EXPRESSION>TO_DATE('$$LOAD_DATE', 'YYYY-MM-DD')</EXPRESSION>
    </TRANSFORMFIELD>

    <!-- Derivation: SCD2 expiry date - 9999-12-31 for current records -->
    <TRANSFORMFIELD NAME="NEW_EXPIRY_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="Output: SCD2 EXPIRY_DATE for new record">
      <EXPRESSION>TO_DATE('9999-12-31', 'YYYY-MM-DD')</EXPRESSION>
    </TRANSFORMFIELD>

    <!-- Derivation: IS_CURRENT flag - Y for new records, N for expired -->
    <TRANSFORMFIELD NAME="NEW_IS_CURRENT" DATATYPE="STRING" PRECISION="1" SCALE="0" DESCRIPTION="Output: IS_CURRENT flag for new record">
      <EXPRESSION>'Y'</EXPRESSION>
    </TRANSFORMFIELD>

    <!-- Derivation: Fields for expiring old current record -->
    <TRANSFORMFIELD NAME="EXPIRE_EFFECTIVE_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="Output: EFFECTIVE_DATE for expire record">
      <EXPRESSION>DIM_EFFECTIVE_DATE</EXPRESSION>
    </TRANSFORMFIELD>

    <!-- Derivation: Set expiry date to yesterday for old current record -->
    <TRANSFORMFIELD NAME="EXPIRE_EXPIRY_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="Output: EXPIRY_DATE for expire record (yesterday)">
      <EXPRESSION>ADD_DAYS(TO_DATE('$$LOAD_DATE', 'YYYY-MM-DD'), -1)</EXPRESSION>
    </TRANSFORMFIELD>

    <TRANSFORMFIELD NAME="EXPIRE_IS_CURRENT" DATATYPE="STRING" PRECISION="1" SCALE="0" DESCRIPTION="Output: IS_CURRENT flag for expire record">
      <EXPRESSION>'N'</EXPRESSION>
    </TRANSFORMFIELD>

    <!-- Pass through surrogate key for updates -->
    <TRANSFORMFIELD NAME="DIM_LOAN_STATUS_KEY_PASSTHROUGH" DATATYPE="BIGINT" PRECISION="19" SCALE="0" DESCRIPTION="Output: dimension key for update operations">
      <EXPRESSION>DIM_LOAN_STATUS_KEY</EXPRESSION>
    </TRANSFORMFIELD>
  </TRANSFORMATION>

  <!-- ===================================================================== -->
  <!-- FILTER: Process Only Records That Need SCD2 Treatment                 -->
  <!-- ===================================================================== -->
  <TRANSFORMATION NAME="FIL_NEEDS_SCD2" TRANSFORMTYPE="Filter">
    <DESCRIPTION>Filter out unchanged records - only process those with NEEDS_SCD2='Y'</DESCRIPTION>
    <PROPERTY NAME="FILTER_CONDITION" VALUE="NEEDS_SCD2 = 'Y'" />
    
    <!-- Pass through all expression output ports -->
    <TRANSFORMFIELD NAME="IS_NEW" DATATYPE="STRING" PRECISION="1" SCALE="0" DESCRIPTION="Output: is new flag" />
    <TRANSFORMFIELD NAME="STATUS_CHANGED" DATATYPE="STRING" PRECISION="1" SCALE="0" DESCRIPTION="Output: status changed flag" />
    <TRANSFORMFIELD NAME="NEEDS_SCD2" DATATYPE="STRING" PRECISION="1" SCALE="0" DESCRIPTION="Output: needs SCD2 flag" />
    <TRANSFORMFIELD NAME="NEW_APPLICATION_ID" DATATYPE="BIGINT" PRECISION="19" SCALE="0" DESCRIPTION="Output: application ID" />
    <TRANSFORMFIELD NAME="NEW_LOAN_STATUS" DATATYPE="STRING" PRECISION="30" SCALE="0" DESCRIPTION="Output: loan status" />
    <TRANSFORMFIELD NAME="NEW_STATUS_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="Output: status date" />
    <TRANSFORMFIELD NAME="NEW_STATUS_REASON" DATATYPE="STRING" PRECISION="500" SCALE="0" DESCRIPTION="Output: status reason" />
    <TRANSFORMFIELD NAME="NEW_SERVICER_ID" DATATYPE="BIGINT" PRECISION="19" SCALE="0" DESCRIPTION="Output: servicer ID" />
    <TRANSFORMFIELD NAME="NEW_NEXT_PAYMENT_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="Output: next payment date" />
    <TRANSFORMFIELD NAME="NEW_OUTSTANDING_BALANCE" DATATYPE="DECIMAL" PRECISION="18" SCALE="2" DESCRIPTION="Output: outstanding balance" />
    <TRANSFORMFIELD NAME="NEW_DAYS_PAST_DUE" DATATYPE="INTEGER" PRECISION="10" SCALE="0" DESCRIPTION="Output: days past due" />
    <TRANSFORMFIELD NAME="NEW_EFFECTIVE_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="Output: effective date" />
    <TRANSFORMFIELD NAME="NEW_EXPIRY_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="Output: expiry date" />
    <TRANSFORMFIELD NAME="NEW_IS_CURRENT" DATATYPE="STRING" PRECISION="1" SCALE="0" DESCRIPTION="Output: is current flag" />
    <TRANSFORMFIELD NAME="EXPIRE_EFFECTIVE_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="Output: effective date for expire" />
    <TRANSFORMFIELD NAME="EXPIRE_EXPIRY_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="Output: expiry date for expire" />
    <TRANSFORMFIELD NAME="EXPIRE_IS_CURRENT" DATATYPE="STRING" PRECISION="1" SCALE="0" DESCRIPTION="Output: is current for expire" />
    <TRANSFORMFIELD NAME="DIM_LOAN_STATUS_KEY_PASSTHROUGH" DATATYPE="BIGINT" PRECISION="19" SCALE="0" DESCRIPTION="Output: dimension key" />
  </TRANSFORMATION>

  <!-- ===================================================================== -->
  <!-- SEQUENCE GENERATOR: Generate Surrogate Keys for New Records           -->
  <!-- ===================================================================== -->
  <TRANSFORMATION NAME="SEQ_LOAN_STATUS_KEY" TRANSFORMTYPE="Sequence Generator">
    <DESCRIPTION>Sequence Generator - creates surrogate keys for new dimension records</DESCRIPTION>
    <PROPERTY NAME="START_VALUE" VALUE="1" />
    <PROPERTY NAME="INCREMENT_BY" VALUE="1" />
    <PROPERTY NAME="CYCLE" VALUE="NO" />
    <PROPERTY NAME="RESET_ON_SESSION_RUN" VALUE="NO" />
    <PROPERTY NAME="CURRVAL_INITIAL_VALUE" VALUE="0" />
    
    <!-- Reset option: Read from dimension to find max key -->
    <PROPERTY NAME="RESET_SEQUENCE_BY_QUERY" VALUE="SELECT MAX(LOAN_STATUS_KEY) FROM DIM_LOAN_STATUS" />
    
    <TRANSFORMFIELD NAME="NEW_LOAN_STATUS_KEY" DATATYPE="BIGINT" PRECISION="19" SCALE="0" DESCRIPTION="Output: generated surrogate key" />
    
    <!-- Pass through all other fields -->
    <TRANSFORMFIELD NAME="IS_NEW" DATATYPE="STRING" PRECISION="1" SCALE="0" DESCRIPTION="Pass: is new flag" />
    <TRANSFORMFIELD NAME="STATUS_CHANGED" DATATYPE="STRING" PRECISION="1" SCALE="0" DESCRIPTION="Pass: status changed flag" />
    <TRANSFORMFIELD NAME="NEW_APPLICATION_ID" DATATYPE="BIGINT" PRECISION="19" SCALE="0" DESCRIPTION="Pass: application ID" />
    <TRANSFORMFIELD NAME="NEW_LOAN_STATUS" DATATYPE="STRING" PRECISION="30" SCALE="0" DESCRIPTION="Pass: loan status" />
    <TRANSFORMFIELD NAME="NEW_STATUS_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="Pass: status date" />
    <TRANSFORMFIELD NAME="NEW_STATUS_REASON" DATATYPE="STRING" PRECISION="500" SCALE="0" DESCRIPTION="Pass: status reason" />
    <TRANSFORMFIELD NAME="NEW_SERVICER_ID" DATATYPE="BIGINT" PRECISION="19" SCALE="0" DESCRIPTION="Pass: servicer ID" />
    <TRANSFORMFIELD NAME="NEW_NEXT_PAYMENT_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="Pass: next payment date" />
    <TRANSFORMFIELD NAME="NEW_OUTSTANDING_BALANCE" DATATYPE="DECIMAL" PRECISION="18" SCALE="2" DESCRIPTION="Pass: outstanding balance" />
    <TRANSFORMFIELD NAME="NEW_DAYS_PAST_DUE" DATATYPE="INTEGER" PRECISION="10" SCALE="0" DESCRIPTION="Pass: days past due" />
    <TRANSFORMFIELD NAME="NEW_EFFECTIVE_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="Pass: effective date" />
    <TRANSFORMFIELD NAME="NEW_EXPIRY_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="Pass: expiry date" />
    <TRANSFORMFIELD NAME="NEW_IS_CURRENT" DATATYPE="STRING" PRECISION="1" SCALE="0" DESCRIPTION="Pass: is current flag" />
    <TRANSFORMFIELD NAME="EXPIRE_EFFECTIVE_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="Pass: effective date for expire" />
    <TRANSFORMFIELD NAME="EXPIRE_EXPIRY_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="Pass: expiry date for expire" />
    <TRANSFORMFIELD NAME="EXPIRE_IS_CURRENT" DATATYPE="STRING" PRECISION="1" SCALE="0" DESCRIPTION="Pass: is current for expire" />
    <TRANSFORMFIELD NAME="DIM_LOAN_STATUS_KEY_PASSTHROUGH" DATATYPE="BIGINT" PRECISION="19" SCALE="0" DESCRIPTION="Pass: dimension key for update" />
  </TRANSFORMATION>

  <!-- ===================================================================== -->
  <!-- EXPRESSION: Finalize SCD2 Fields and Set CREATED_DATE                 -->
  <!-- ===================================================================== -->
  <TRANSFORMATION NAME="EXP_SET_SCD2_FIELDS" TRANSFORMTYPE="Expression">
    <DESCRIPTION>Finalize all SCD2 fields and set CREATED_DATE for audit trail</DESCRIPTION>
    
    <!-- Input ports from sequence generator -->
    <TRANSFORMFIELD NAME="NEW_LOAN_STATUS_KEY" DATATYPE="BIGINT" PRECISION="19" SCALE="0" DESCRIPTION="Input: generated key" />
    <TRANSFORMFIELD NAME="IS_NEW" DATATYPE="STRING" PRECISION="1" SCALE="0" DESCRIPTION="Input: is new flag" />
    <TRANSFORMFIELD NAME="STATUS_CHANGED" DATATYPE="STRING" PRECISION="1" SCALE="0" DESCRIPTION="Input: status changed flag" />
    <TRANSFORMFIELD NAME="NEW_APPLICATION_ID" DATATYPE="BIGINT" PRECISION="19" SCALE="0" DESCRIPTION="Input: application ID" />
    <TRANSFORMFIELD NAME="NEW_LOAN_STATUS" DATATYPE="STRING" PRECISION="30" SCALE="0" DESCRIPTION="Input: loan status" />
    <TRANSFORMFIELD NAME="NEW_STATUS_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="Input: status date" />
    <TRANSFORMFIELD NAME="NEW_STATUS_REASON" DATATYPE="STRING" PRECISION="500" SCALE="0" DESCRIPTION="Input: status reason" />
    <TRANSFORMFIELD NAME="NEW_SERVICER_ID" DATATYPE="BIGINT" PRECISION="19" SCALE="0" DESCRIPTION="Input: servicer ID" />
    <TRANSFORMFIELD NAME="NEW_NEXT_PAYMENT_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="Input: next payment date" />
    <TRANSFORMFIELD NAME="NEW_OUTSTANDING_BALANCE" DATATYPE="DECIMAL" PRECISION="18" SCALE="2" DESCRIPTION="Input: outstanding balance" />
    <TRANSFORMFIELD NAME="NEW_DAYS_PAST_DUE" DATATYPE="INTEGER" PRECISION="10" SCALE="0" DESCRIPTION="Input: days past due" />
    <TRANSFORMFIELD NAME="NEW_EFFECTIVE_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="Input: effective date" />
    <TRANSFORMFIELD NAME="NEW_EXPIRY_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="Input: expiry date" />
    <TRANSFORMFIELD NAME="NEW_IS_CURRENT" DATATYPE="STRING" PRECISION="1" SCALE="0" DESCRIPTION="Input: is current flag" />
    <TRANSFORMFIELD NAME="EXPIRE_EFFECTIVE_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="Input: effective date for expire" />
    <TRANSFORMFIELD NAME="EXPIRE_EXPIRY_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="Input: expiry date for expire" />
    <TRANSFORMFIELD NAME="EXPIRE_IS_CURRENT" DATATYPE="STRING" PRECISION="1" SCALE="0" DESCRIPTION="Input: is current for expire" />
    <TRANSFORMFIELD NAME="DIM_LOAN_STATUS_KEY_PASSTHROUGH" DATATYPE="BIGINT" PRECISION="19" SCALE="0" DESCRIPTION="Input: dimension key for update" />

    <!-- Output: Direct mappings to target fields -->
    <TRANSFORMFIELD NAME="OUT_LOAN_STATUS_KEY" DATATYPE="BIGINT" PRECISION="19" SCALE="0" DESCRIPTION="Output: surrogate key">
      <EXPRESSION>NEW_LOAN_STATUS_KEY</EXPRESSION>
    </TRANSFORMFIELD>

    <TRANSFORMFIELD NAME="OUT_APPLICATION_ID" DATATYPE="BIGINT" PRECISION="19" SCALE="0" DESCRIPTION="Output: application ID">
      <EXPRESSION>NEW_APPLICATION_ID</EXPRESSION>
    </TRANSFORMFIELD>

    <TRANSFORMFIELD NAME="OUT_LOAN_STATUS" DATATYPE="STRING" PRECISION="30" SCALE="0" DESCRIPTION="Output: loan status">
      <EXPRESSION>NEW_LOAN_STATUS</EXPRESSION>
    </TRANSFORMFIELD>

    <TRANSFORMFIELD NAME="OUT_STATUS_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="Output: status date">
      <EXPRESSION>NEW_STATUS_DATE</EXPRESSION>
    </TRANSFORMFIELD>

    <TRANSFORMFIELD NAME="OUT_STATUS_REASON" DATATYPE="STRING" PRECISION="500" SCALE="0" DESCRIPTION="Output: status reason">
      <EXPRESSION>NEW_STATUS_REASON</EXPRESSION>
    </TRANSFORMFIELD>

    <TRANSFORMFIELD NAME="OUT_SERVICER_ID" DATATYPE="BIGINT" PRECISION="19" SCALE="0" DESCRIPTION="Output: servicer ID">
      <EXPRESSION>NEW_SERVICER_ID</EXPRESSION>
    </TRANSFORMFIELD>

    <TRANSFORMFIELD NAME="OUT_NEXT_PAYMENT_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="Output: next payment date">
      <EXPRESSION>NEW_NEXT_PAYMENT_DATE</EXPRESSION>
    </TRANSFORMFIELD>

    <TRANSFORMFIELD NAME="OUT_OUTSTANDING_BALANCE" DATATYPE="DECIMAL" PRECISION="18" SCALE="2" DESCRIPTION="Output: outstanding balance">
      <EXPRESSION>NEW_OUTSTANDING_BALANCE</EXPRESSION>
    </TRANSFORMFIELD>

    <TRANSFORMFIELD NAME="OUT_DAYS_PAST_DUE" DATATYPE="INTEGER" PRECISION="10" SCALE="0" DESCRIPTION="Output: days past due">
      <EXPRESSION>NEW_DAYS_PAST_DUE</EXPRESSION>
    </TRANSFORMFIELD>

    <TRANSFORMFIELD NAME="OUT_EFFECTIVE_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="Output: SCD2 effective date">
      <EXPRESSION>NEW_EFFECTIVE_DATE</EXPRESSION>
    </TRANSFORMFIELD>

    <TRANSFORMFIELD NAME="OUT_EXPIRY_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="Output: SCD2 expiry date">
      <EXPRESSION>NEW_EXPIRY_DATE</EXPRESSION>
    </TRANSFORMFIELD>

    <TRANSFORMFIELD NAME="OUT_IS_CURRENT" DATATYPE="STRING" PRECISION="1" SCALE="0" DESCRIPTION="Output: is current flag">
      <EXPRESSION>NEW_IS_CURRENT</EXPRESSION>
    </TRANSFORMFIELD>

    <!-- Derivation: Set CREATED_DATE to load date for audit -->
    <TRANSFORMFIELD NAME="OUT_CREATED_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="Output: record creation date">
      <EXPRESSION>TO_DATE('$$LOAD_DATE', 'YYYY-MM-DD')</EXPRESSION>
    </TRANSFORMFIELD>

    <!-- Pass through flags and keys for update strategy -->
    <TRANSFORMFIELD NAME="IS_NEW_FLAG" DATATYPE="STRING" PRECISION="1" SCALE="0" DESCRIPTION="Output: is new flag">
      <EXPRESSION>IS_NEW</EXPRESSION>
    </TRANSFORMFIELD>

    <TRANSFORMFIELD NAME="STATUS_CHANGED_FLAG" DATATYPE="STRING" PRECISION="1" SCALE="0" DESCRIPTION="Output: status changed flag">
      <EXPRESSION>STATUS_CHANGED</EXPRESSION>
    </TRANSFORMFIELD>

    <TRANSFORMFIELD NAME="EXPIRE_KEY" DATATYPE="BIGINT" PRECISION="19" SCALE="0" DESCRIPTION="Output: key for expiring old record">
      <EXPRESSION>DIM_LOAN_STATUS_KEY_PASSTHROUGH</EXPRESSION>
    </TRANSFORMFIELD>

    <TRANSFORMFIELD NAME="EXPIRE_EFF_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="Output: effective date for expire record">
      <EXPRESSION>EXPIRE_EFFECTIVE_DATE</EXPRESSION>
    </TRANSFORMFIELD>

    <TRANSFORMFIELD NAME="EXPIRE_EXP_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="Output: expiry date for expire record">
      <EXPRESSION>EXPIRE_EXPIRY_DATE</EXPRESSION>
    </TRANSFORMFIELD>

    <TRANSFORMFIELD NAME="EXPIRE_CURR_FLAG" DATATYPE="STRING" PRECISION="1" SCALE="0" DESCRIPTION="Output: is current for expire record">
      <EXPRESSION>EXPIRE_IS_CURRENT</EXPRESSION>
    </TRANSFORMFIELD>
  </TRANSFORMATION>

  <!-- ===================================================================== -->
  <!-- UPDATE STRATEGY: Route Records Based on Operation Type                -->
  <!-- DD_INSERT for new records, DD_UPDATE for expiring old ones            -->
  <!-- ===================================================================== -->
  <TRANSFORMATION NAME="UPD_SCD2_STRATEGY" TRANSFORMTYPE="Update Strategy">
    <DESCRIPTION>Update Strategy - routes new records to insert, old current records to update (expire)</DESCRIPTION>
    <PROPERTY NAME="UPDATE_STRATEGY_EXPRESSION" VALUE="IIF(IS_NEW_FLAG='Y' OR STATUS_CHANGED_FLAG='Y', DD_INSERT, DD_UPDATE)" />
    <PROPERTY NAME="TREAT_SOURCE_ROWS_AS_UPDATE" VALUE="NO" />
    <PROPERTY NAME="TREAT_SOURCE_ROWS_AS_DELETE" VALUE="NO" />
    
    <!-- Input ports from expression -->
    <TRANSFORMFIELD NAME="OUT_LOAN_STATUS_KEY" DATATYPE="BIGINT" PRECISION="19" SCALE="0" DESCRIPTION="Surrogate key" />
    <TRANSFORMFIELD NAME="OUT_APPLICATION_ID" DATATYPE="BIGINT" PRECISION="19" SCALE="0" DESCRIPTION="Application ID" />
    <TRANSFORMFIELD NAME="OUT_LOAN_STATUS" DATATYPE="STRING" PRECISION="30" SCALE="0" DESCRIPTION="Loan status" />
    <TRANSFORMFIELD NAME="OUT_STATUS_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="Status date" />
    <TRANSFORMFIELD NAME="OUT_STATUS_REASON" DATATYPE="STRING" PRECISION="500" SCALE="0" DESCRIPTION="Status reason" />
    <TRANSFORMFIELD NAME="OUT_SERVICER_ID" DATATYPE="BIGINT" PRECISION="19" SCALE="0" DESCRIPTION="Servicer ID" />
    <TRANSFORMFIELD NAME="OUT_NEXT_PAYMENT_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="Next payment date" />
    <TRANSFORMFIELD NAME="OUT_OUTSTANDING_BALANCE" DATATYPE="DECIMAL" PRECISION="18" SCALE="2" DESCRIPTION="Outstanding balance" />
    <TRANSFORMFIELD NAME="OUT_DAYS_PAST_DUE" DATATYPE="INTEGER" PRECISION="10" SCALE="0" DESCRIPTION="Days past due" />
    <TRANSFORMFIELD NAME="OUT_EFFECTIVE_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="SCD2 effective date" />
    <TRANSFORMFIELD NAME="OUT_EXPIRY_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="SCD2 expiry date" />
    <TRANSFORMFIELD NAME="OUT_IS_CURRENT" DATATYPE="STRING" PRECISION="1" SCALE="0" DESCRIPTION="Is current flag" />
    <TRANSFORMFIELD NAME="OUT_CREATED_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="Created date" />
    <TRANSFORMFIELD NAME="IS_NEW_FLAG" DATATYPE="STRING" PRECISION="1" SCALE="0" DESCRIPTION="Is new flag" />
    <TRANSFORMFIELD NAME="STATUS_CHANGED_FLAG" DATATYPE="STRING" PRECISION="1" SCALE="0" DESCRIPTION="Status changed flag" />
    <TRANSFORMFIELD NAME="EXPIRE_KEY" DATATYPE="BIGINT" PRECISION="19" SCALE="0" DESCRIPTION="Key for expire record" />
    <TRANSFORMFIELD NAME="EXPIRE_EFF_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="Effective date for expire" />
    <TRANSFORMFIELD NAME="EXPIRE_EXP_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" DESCRIPTION="Expiry date for expire" />
    <TRANSFORMFIELD NAME="EXPIRE_CURR_FLAG" DATATYPE="STRING" PRECISION="1" SCALE="0" DESCRIPTION="Is current for expire" />
  </TRANSFORMATION>

  <!-- ===================================================================== -->
  <!-- TARGET: Snowflake DIM_LOAN_STATUS                                     -->
  <!-- ===================================================================== -->
  <TARGET NAME="TGT_DIM_LOAN_STATUS" TARGETCONNECTION="$$TGT_CONNECTION" 
           TARGETTYPE="RelationalTarget" DATABASETYPE="Snowflake">
    <DESCRIPTION>Snowflake target dimension table - DIM_LOAN_STATUS</DESCRIPTION>
    <TABLENAME>DIM_LOAN_STATUS</TABLENAME>
    
    <!-- Target fields matching source structure -->
    <TARGETFIELD NAME="LOAN_STATUS_KEY" DATATYPE="BIGINT" PRECISION="19" SCALE="0" 
                  ISKEY="Y" ISKEYPRIMARY="Y" />
    <TARGETFIELD NAME="APPLICATION_ID" DATATYPE="BIGINT" PRECISION="19" SCALE="0" 
                  ISKEY="N" />
    <TARGETFIELD NAME="LOAN_STATUS" DATATYPE="STRING" PRECISION="30" SCALE="0" 
                  ISKEY="N" />
    <TARGETFIELD NAME="STATUS_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" 
                  ISKEY="N" />
    <TARGETFIELD NAME="STATUS_REASON" DATATYPE="STRING" PRECISION="500" SCALE="0" 
                  ISKEY="N" />
    <TARGETFIELD NAME="SERVICER_ID" DATATYPE="BIGINT" PRECISION="19" SCALE="0" 
                  ISKEY="N" />
    <TARGETFIELD NAME="NEXT_PAYMENT_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" 
                  ISKEY="N" />
    <TARGETFIELD NAME="OUTSTANDING_BALANCE" DATATYPE="DECIMAL" PRECISION="18" SCALE="2" 
                  ISKEY="N" />
    <TARGETFIELD NAME="DAYS_PAST_DUE" DATATYPE="INTEGER" PRECISION="10" SCALE="0" 
                  ISKEY="N" />
    <TARGETFIELD NAME="EFFECTIVE_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" 
                  ISKEY="N" DESCRIPTION="SCD2 effective date" />
    <TARGETFIELD NAME="EXPIRY_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" 
                  ISKEY="N" DESCRIPTION="SCD2 expiry date (9999-12-31 for current)" />
    <TARGETFIELD NAME="IS_CURRENT" DATATYPE="STRING" PRECISION="1" SCALE="0" 
                  ISKEY="N" DESCRIPTION="Current flag (Y/N)" />
    <TARGETFIELD NAME="CREATED_DATE" DATATYPE="DATE" PRECISION="10" SCALE="0" 
                  ISKEY="N" DESCRIPTION="Record creation date for audit" />
    
    <!-- Load type and error handling -->
    <PROPERTY NAME="LOADTYPE" VALUE="BULKLOAD" />
    <PROPERTY NAME="ERRORLIMIT" VALUE="0" />
    <PROPERTY NAME="TRACEMODE" VALUE="NO" />
    <PROPERTY NAME="PRELOAD_SQL" VALUE="" />
    <PROPERTY NAME="POSTLOAD_SQL" VALUE="" />
  </TARGET>

  <!-- ===================================================================== -->
  <!-- CONNECTORS: Link transformations and map fields                       -->
  <!-- ===================================================================== -->
  
  <!-- Connector: SQ_LOAN_STATUS_UPDATES -> JNR_DETECT_CHANGES (detail side) -->
  <CONNECTOR SOURCE="SQ_LOAN_STATUS_UPDATES" TARGET="JNR_DETECT_CHANGES">
    <FIELDMAPPING SOURCEPORT="APPLICATION_ID" TARGETPORT="SRC_APPLICATION_ID" />
    <FIELDMAPPING SOURCEPORT="LOAN_STATUS" TARGETPORT="SRC_LOAN_STATUS" />
    <FIELDMAPPING SOURCEPORT="STATUS_DATE" TARGETPORT="SRC_STATUS_DATE" />
    <FIELDMAPPING SOURCEPORT="STATUS_REASON" TARGETPORT="SRC_STATUS_REASON" />
    <FIELDMAPPING SOURCEPORT="SERVICER_ID" TARGETPORT="SRC_SERVICER_ID" />
    <FIELDMAPPING SOURCEPORT="NEXT_PAYMENT_DATE" TARGETPORT="SRC_NEXT_PAYMENT_DATE" />
    <FIELDMAPPING SOURCEPORT="OUTSTANDING_BALANCE" TARGETPORT="SRC_OUTSTANDING_BALANCE" />
    <FIELDMAPPING SOURCEPORT="DAYS_PAST_DUE" TARGETPORT="SRC_DAYS_PAST_DUE" />
  </CONNECTOR>

  <!-- Connector: SQ_DIM_LOAN_STATUS_CURRENT -> JNR_DETECT_CHANGES (master side) -->
  <CONNECTOR SOURCE="SQ_DIM_LOAN_STATUS_CURRENT" TARGET="JNR_DETECT_CHANGES">
    <FIELDMAPPING SOURCEPORT="LOAN_STATUS_KEY" TARGETPORT="DIM_LOAN_STATUS_KEY" />
    <FIELDMAPPING SOURCEPORT="APPLICATION_ID" TARGETPORT="DIM_APPLICATION_ID" />
    <FIELDMAPPING SOURCEPORT="LOAN_STATUS" TARGETPORT="DIM_LOAN_STATUS" />
    <FIELDMAPPING SOURCEPORT="STATUS_DATE" TARGETPORT="DIM_STATUS_DATE" />
    <FIELDMAPPING SOURCEPORT="STATUS_REASON" TARGETPORT="DIM_STATUS_REASON" />
    <FIELDMAPPING SOURCEPORT="SERVICER_ID" TARGETPORT="DIM_SERVICER_ID" />
    <FIELDMAPPING SOURCEPORT="NEXT_PAYMENT_DATE" TARGETPORT="DIM_NEXT_PAYMENT_DATE" />
    <FIELDMAPPING SOURCEPORT="OUTSTANDING_BALANCE" TARGETPORT="DIM_OUTSTANDING_BALANCE" />
    <FIELDMAPPING SOURCEPORT="DAYS_PAST_DUE" TARGETPORT="DIM_DAYS_PAST_DUE" />
    <FIELDMAPPING SOURCEPORT="EFFECTIVE_DATE" TARGETPORT="DIM_EFFECTIVE_DATE" />
    <FIELDMAPPING SOURCEPORT="EXPIRY_DATE" TARGETPORT="DIM_EXPIRY_DATE" />
  </CONNECTOR>

  <!-- Connector: JNR_DETECT_CHANGES -> EXP_DETECT_CHANGES -->
  <CONNECTOR SOURCE="JNR_DETECT_CHANGES" TARGET="EXP_DETECT_CHANGES">
    <FIELDMAPPING SOURCEPORT="DIM_LOAN_STATUS_KEY" TARGETPORT="DIM_LOAN_STATUS_KEY" />
    <FIELDMAPPING SOURCEPORT="DIM_APPLICATION_ID" TARGETPORT="DIM_APPLICATION_ID" />
    <FIELDMAPPING SOURCEPORT="DIM_LOAN_STATUS" TARGETPORT="DIM_LOAN_STATUS" />
    <FIELDMAPPING SOURCEPORT="DIM_STATUS_DATE" TARGETPORT="DIM_STATUS_DATE" />
    <FIELDMAPPING SOURCEPORT="DIM_STATUS_REASON" TARGETPORT="DIM_STATUS_REASON" />
    <FIELDMAPPING SOURCEPORT="DIM_SERVICER_ID" TARGETPORT="DIM_SERVICER_ID" />
    <FIELDMAPPING SOURCEPORT="DIM_NEXT_PAYMENT_DATE" TARGETPORT="DIM_NEXT_PAYMENT_DATE" />
    <FIELDMAPPING SOURCEPORT="DIM_OUTSTANDING_BALANCE" TARGETPORT="DIM_OUTSTANDING_BALANCE" />
    <FIELDMAPPING SOURCEPORT="DIM_DAYS_PAST_DUE" TARGETPORT="DIM_DAYS_PAST_DUE" />
    <FIELDMAPPING SOURCEPORT="DIM_EFFECTIVE_DATE" TARGETPORT="DIM_EFFECTIVE_DATE" />
    <FIELDMAPPING SOURCEPORT="SRC_APPLICATION_ID" TARGETPORT="SRC_APPLICATION_ID" />
    <FIELDMAPPING SOURCEPORT="SRC_LOAN_STATUS" TARGETPORT="SRC_LOAN_STATUS" />
    <FIELDMAPPING SOURCEPORT="SRC_STATUS_DATE" TARGETPORT="SRC_STATUS_DATE" />
    <FIELDMAPPING SOURCEPORT="SRC_STATUS_REASON" TARGETPORT="SRC_STATUS_REASON" />
    <FIELDMAPPING SOURCEPORT="SRC_SERVICER_ID" TARGETPORT="SRC_SERVICER_ID" />
    <FIELDMAPPING SOURCEPORT="SRC_NEXT_PAYMENT_DATE" TARGETPORT="SRC_NEXT_PAYMENT_DATE" />
    <FIELDMAPPING SOURCEPORT="SRC_OUTSTANDING_BALANCE" TARGETPORT="SRC_OUTSTANDING_BALANCE" />
    <FIELDMAPPING SOURCEPORT="SRC_DAYS_PAST_DUE" TARGETPORT="SRC_DAYS_PAST_DUE" />
  </CONNECTOR>

  <!-- Connector: EXP_DETECT_CHANGES -> FIL_NEEDS_SCD2 -->
  <CONNECTOR SOURCE="EXP_DETECT_CHANGES" TARGET="FIL_NEEDS_SCD2">
    <FIELDMAPPING SOURCEPORT="IS_NEW" TARGETPORT="IS_NEW" />
    <FIELDMAPPING SOURCEPORT="STATUS_CHANGED" TARGETPORT="STATUS_CHANGED" />
    <FIELDMAPPING SOURCEPORT="NEEDS_SCD2" TARGETPORT="NEEDS_SCD2" />
    <FIELDMAPPING SOURCEPORT="NEW_APPLICATION_ID" TARGETPORT="NEW_APPLICATION_ID" />
    <FIELDMAPPING SOURCEPORT="NEW_LOAN_STATUS" TARGETPORT="NEW_LOAN_STATUS" />
    <FIELDMAPPING SOURCEPORT="NEW_STATUS_DATE" TARGETPORT="NEW_STATUS_DATE" />
    <FIELDMAPPING SOURCEPORT="NEW_STATUS_REASON" TARGETPORT="NEW_STATUS_REASON" />
    <FIELDMAPPING SOURCEPORT="NEW_SERVICER_ID" TARGETPORT="NEW_SERVICER_ID" />
    <FIELDMAPPING SOURCEPORT="NEW_NEXT_PAYMENT_DATE" TARGETPORT="NEW_NEXT_PAYMENT_DATE" />
    <FIELDMAPPING SOURCEPORT="NEW_OUTSTANDING_BALANCE" TARGETPORT="NEW_OUTSTANDING_BALANCE" />
    <FIELDMAPPING SOURCEPORT="NEW_DAYS_PAST_DUE" TARGETPORT="NEW_DAYS_PAST_DUE" />
    <FIELDMAPPING SOURCEPORT="NEW_EFFECTIVE_DATE" TARGETPORT="NEW_EFFECTIVE_DATE" />
    <FIELDMAPPING SOURCEPORT="NEW_EXPIRY_DATE" TARGETPORT="NEW_EXPIRY_DATE" />
    <FIELDMAPPING SOURCEPORT="NEW_IS_CURRENT" TARGETPORT="NEW_IS_CURRENT" />
    <FIELDMAPPING SOURCEPORT="EXPIRE_EFFECTIVE_DATE" TARGETPORT="EXPIRE_EFFECTIVE_DATE" />
    <FIELDMAPPING SOURCEPORT="EXPIRE_EXPIRY_DATE" TARGETPORT="EXPIRE_EXPIRY_DATE" />
    <FIELDMAPPING SOURCEPORT="EXPIRE_IS_CURRENT" TARGETPORT="EXPIRE_IS_CURRENT" />
    <FIELDMAPPING SOURCEPORT="DIM_LOAN_STATUS_KEY_PASSTHROUGH" TARGETPORT="DIM_LOAN_STATUS_KEY_PASSTHROUGH" />
  </CONNECTOR>

  <!-- Connector: FIL_NEEDS_SCD2 -> SEQ_LOAN_STATUS_KEY -->
  <CONNECTOR SOURCE="FIL_NEEDS_SCD2" TARGET="SEQ_LOAN_STATUS_KEY">
    <FIELDMAPPING SOURCEPORT="IS_NEW" TARGETPORT="IS_NEW" />
    <FIELDMAPPING SOURCEPORT="STATUS_CHANGED" TARGETPORT="STATUS_CHANGED" />
    <FIELDMAPPING SOURCEPORT="NEW_APPLICATION_ID" TARGETPORT="NEW_APPLICATION_ID" />
    <FIELDMAPPING SOURCEPORT="NEW_LOAN_STATUS" TARGETPORT="NEW_LOAN_STATUS" />
    <FIELDMAPPING SOURCEPORT="NEW_STATUS_DATE" TARGETPORT="NEW_STATUS_DATE" />
    <FIELDMAPPING SOURCEPORT="NEW_STATUS_REASON" TARGETPORT="NEW_STATUS_REASON" />
    <FIELDMAPPING SOURCEPORT="NEW_SERVICER_ID" TARGETPORT="NEW_SERVICER_ID" />
    <FIELDMAPPING SOURCEPORT="NEW_NEXT_PAYMENT_DATE" TARGETPORT="NEW_NEXT_PAYMENT_DATE" />
    <FIELDMAPPING SOURCEPORT="NEW_OUTSTANDING_BALANCE" TARGETPORT="NEW_OUTSTANDING_BALANCE" />
    <FIELDMAPPING SOURCEPORT="NEW_DAYS_PAST_DUE" TARGETPORT="NEW_DAYS_PAST_DUE" />
    <FIELDMAPPING SOURCEPORT="NEW_EFFECTIVE_DATE" TARGETPORT="NEW_EFFECTIVE_DATE" />
    <FIELDMAPPING SOURCEPORT="NEW_EXPIRY_DATE" TARGETPORT="NEW_EXPIRY_DATE" />
    <FIELDMAPPING SOURCEPORT="NEW_IS_CURRENT" TARGETPORT="NEW_IS_CURRENT" />
    <FIELDMAPPING SOURCEPORT="EXPIRE_EFFECTIVE_DATE" TARGETPORT="EXPIRE_EFFECTIVE_DATE" />
    <FIELDMAPPING SOURCEPORT="EXPIRE_EXPIRY_DATE" TARGETPORT="EXPIRE_EXPIRY_DATE" />
    <FIELDMAPPING SOURCEPORT="EXPIRE_IS_CURRENT" TARGETPORT="EXPIRE_IS_CURRENT" />
    <FIELDMAPPING SOURCEPORT="DIM_LOAN_STATUS_KEY_PASSTHROUGH" TARGETPORT="DIM_LOAN_STATUS_KEY_PASSTHROUGH" />
  </CONNECTOR>

  <!-- Connector: SEQ_LOAN_STATUS_KEY -> EXP_SET_SCD2_FIELDS -->
  <CONNECTOR SOURCE="SEQ_LOAN_STATUS_KEY" TARGET="EXP_SET_SCD2_FIELDS">
    <FIELDMAPPING SOURCEPORT="NEW_LOAN_STATUS_KEY" TARGETPORT="NEW_LOAN_STATUS_KEY" />
    <FIELDMAPPING SOURCEPORT="IS_NEW" TARGETPORT="IS_NEW" />
    <FIELDMAPPING SOURCEPORT="STATUS_CHANGED" TARGETPORT="STATUS_CHANGED" />
    <FIELDMAPPING SOURCEPORT="NEW_APPLICATION_ID" TARGETPORT="NEW_APPLICATION_ID" />
    <FIELDMAPPING SOURCEPORT="NEW_LOAN_STATUS" TARGETPORT="NEW_LOAN_STATUS" />
    <FIELDMAPPING SOURCEPORT="NEW_STATUS_DATE" TARGETPORT="NEW_STATUS_DATE" />
    <FIELDMAPPING SOURCEPORT="NEW_STATUS_REASON" TARGETPORT="NEW_STATUS_REASON" />
    <FIELDMAPPING SOURCEPORT="NEW_SERVICER_ID" TARGETPORT="NEW_SERVICER_ID" />
    <FIELDMAPPING SOURCEPORT="NEW_NEXT_PAYMENT_DATE" TARGETPORT="NEW_NEXT_PAYMENT_DATE" />
    <FIELDMAPPING SOURCEPORT="NEW_OUTSTANDING_BALANCE" TARGETPORT="NEW_OUTSTANDING_BALANCE" />
    <FIELDMAPPING SOURCEPORT="NEW_DAYS_PAST_DUE" TARGETPORT="NEW_DAYS_PAST_DUE" />
    <FIELDMAPPING SOURCEPORT="NEW_EFFECTIVE_DATE" TARGETPORT="NEW_EFFECTIVE_DATE" />
    <FIELDMAPPING SOURCEPORT="NEW_EXPIRY_DATE" TARGETPORT="NEW_EXPIRY_DATE" />
    <FIELDMAPPING SOURCEPORT="NEW_IS_CURRENT" TARGETPORT="NEW_IS_CURRENT" />
    <FIELDMAPPING SOURCEPORT="EXPIRE_EFFECTIVE_DATE" TARGETPORT="EXPIRE_EFFECTIVE_DATE" />
    <FIELDMAPPING SOURCEPORT="EXPIRE_EXPIRY_DATE" TARGETPORT="EXPIRE_EXPIRY_DATE" />
    <FIELDMAPPING SOURCEPORT="EXPIRE_IS_CURRENT" TARGETPORT="EXPIRE_IS_CURRENT" />
    <FIELDMAPPING SOURCEPORT="DIM_LOAN_STATUS_KEY_PASSTHROUGH" TARGETPORT="DIM_LOAN_STATUS_KEY_PASSTHROUGH" />
  </CONNECTOR>

  <!-- Connector: EXP_SET_SCD2_FIELDS -> UPD_SCD2_STRATEGY -->
  <CONNECTOR SOURCE="EXP_SET_SCD2_FIELDS" TARGET="UPD_SCD2_STRATEGY">
    <FIELDMAPPING SOURCEPORT="OUT_LOAN_STATUS_KEY" TARGETPORT="OUT_LOAN_STATUS_KEY" />
    <FIELDMAPPING SOURCEPORT="OUT_APPLICATION_ID" TARGETPORT="OUT_APPLICATION_ID" />
    <FIELDMAPPING SOURCEPORT="OUT_LOAN_STATUS" TARGETPORT="OUT_LOAN_STATUS" />
    <FIELDMAPPING SOURCEPORT="OUT_STATUS_DATE" TARGETPORT="OUT_STATUS_DATE" />
    <FIELDMAPPING SOURCEPORT="OUT_STATUS_REASON" TARGETPORT="OUT_STATUS_REASON" />
    <FIELDMAPPING SOURCEPORT="OUT_SERVICER_ID" TARGETPORT="OUT_SERVICER_ID" />
    <FIELDMAPPING SOURCEPORT="OUT_NEXT_PAYMENT_DATE" TARGETPORT="OUT_NEXT_PAYMENT_DATE" />
    <FIELDMAPPING SOURCEPORT="OUT_OUTSTANDING_BALANCE" TARGETPORT="OUT_OUTSTANDING_BALANCE" />
    <FIELDMAPPING SOURCEPORT="OUT_DAYS_PAST_DUE" TARGETPORT="OUT_DAYS_PAST_DUE" />
    <FIELDMAPPING SOURCEPORT="OUT_EFFECTIVE_DATE" TARGETPORT="OUT_EFFECTIVE_DATE" />
    <FIELDMAPPING SOURCEPORT="OUT_EXPIRY_DATE" TARGETPORT="OUT_EXPIRY_DATE" />
    <FIELDMAPPING SOURCEPORT="OUT_IS_CURRENT" TARGETPORT="OUT_IS_CURRENT" />
    <FIELDMAPPING SOURCEPORT="OUT_CREATED_DATE" TARGETPORT="OUT_CREATED_DATE" />
    <FIELDMAPPING SOURCEPORT="IS_NEW_FLAG" TARGETPORT="IS_NEW_FLAG" />
    <FIELDMAPPING SOURCEPORT="STATUS_CHANGED_FLAG" TARGETPORT="STATUS_CHANGED_FLAG" />
    <FIELDMAPPING SOURCEPORT="EXPIRE_KEY" TARGETPORT="EXPIRE_KEY" />
    <FIELDMAPPING SOURCEPORT="EXPIRE_EFF_DATE" TARGETPORT="EXPIRE_EFF_DATE" />
    <FIELDMAPPING SOURCEPORT="EXPIRE_EXP_DATE" TARGETPORT="EXPIRE_EXP_DATE" />
    <FIELDMAPPING SOURCEPORT="EXPIRE_CURR_FLAG" TARGETPORT="EXPIRE_CURR_FLAG" />
  </CONNECTOR>

  <!-- Connector: UPD_SCD2_STRATEGY -> TGT_DIM_LOAN_STATUS -->
  <CONNECTOR SOURCE="UPD_SCD2_STRATEGY" TARGET="TGT_DIM_LOAN_STATUS">
    <FIELDMAPPING SOURCEPORT="OUT_LOAN_STATUS_KEY" TARGETFIELD="LOAN_STATUS_KEY" />
    <FIELDMAPPING SOURCEPORT="OUT_APPLICATION_ID" TARGETFIELD="APPLICATION_ID" />
    <FIELDMAPPING SOURCEPORT="OUT_LOAN_STATUS" TARGETFIELD="LOAN_STATUS" />
    <FIELDMAPPING SOURCEPORT="OUT_STATUS_DATE" TARGETFIELD="STATUS_DATE" />
    <FIELDMAPPING SOURCEPORT="OUT_STATUS_REASON" TARGETFIELD="STATUS_REASON" />
    <FIELDMAPPING SOURCEPORT="OUT_SERVICER_ID" TARGETFIELD="SERVICER_ID" />
    <FIELDMAPPING SOURCEPORT="OUT_NEXT_PAYMENT_DATE" TARGETFIELD="NEXT_PAYMENT_DATE" />
    <FIELDMAPPING SOURCEPORT="OUT_OUTSTANDING_BALANCE" TARGETFIELD="OUTSTANDING_BALANCE" />
    <FIELDMAPPING SOURCEPORT="OUT_DAYS_PAST_DUE" TARGETFIELD="DAYS_PAST_DUE" />
    <FIELDMAPPING SOURCEPORT="OUT_EFFECTIVE_DATE" TARGETFIELD="EFFECTIVE_DATE" />
    <FIELDMAPPING SOURCEPORT="OUT_EXPIRY_DATE" TARGETFIELD="EXPIRY_DATE" />
    <FIELDMAPPING SOURCEPORT="OUT_IS_CURRENT" TARGETFIELD="IS_CURRENT" />
    <FIELDMAPPING SOURCEPORT="OUT_CREATED_DATE" TARGETFIELD="CREATED_DATE" />
  </CONNECTOR>

  <!-- ===================================================================== -->
  <!-- MAPPING-LEVEL PARAMETERS AND SETTINGS                                -->
  <!-- ===================================================================== -->
  <MAPPINGPARAMETERS>
    <!-- Variable definitions used in mapping expressions -->
    <PARAMETER NAME="$$LOAD_DATE" DATATYPE="DATE" DEFAULTVALUE="SYSDATE" 
               DESCRIPTION="Current batch load date in YYYY-MM-DD format" />
    <PARAMETER NAME="$$SRC_CONNECTION" DATATYPE="STRING" DEFAULTVALUE="oracle_prod" 
               DESCRIPTION="Oracle operational system connection reference" />
    <PARAMETER NAME="$$DIM_CONNECTION" DATATYPE="STRING" DEFAULTVALUE="snowflake_prod" 
               DESCRIPTION="Snowflake dimension database connection" />
    <PARAMETER NAME="$$TGT_CONNECTION" DATATYPE="STRING" DEFAULTVALUE="snowflake_prod" 
               DESCRIPTION="Snowflake target database connection" />
    <PARAMETER NAME="$$REJECT_FILE_DIR" DATATYPE="STRING" DEFAULTVALUE="/data/rejects" 
               DESCRIPTION="Directory for bad record files and error logging" />
    <PARAMETER NAME="$$ENV" DATATYPE="STRING" DEFAULTVALUE="PROD" 
               DESCRIPTION="Environment: DEV, UAT, or PROD" />
  </MAPPINGPARAMETERS>

  <!-- ===================================================================== -->
  <!-- SESSION CONFIGURATION NOTES                                           -->
  <!-- ===================================================================== -->
  <SESSIONCONFIG>
    <PROPERTY NAME="BULK_LOAD" VALUE="YES" />
    <PROPERTY NAME="CONCURRENT_SESSIONS" VALUE="2" />
    <PROPERTY NAME="ERROR_HANDLING" VALUE="FAIL_ON_ERROR" />
    <PROPERTY NAME="RECOVERY_MODE" VALUE="RESTART" />
    <PROPERTY NAME="COMMIT_FREQUENCY" VALUE="10000" />
    <PROPERTY NAME="CACHE_PERSISTENCE" VALUE="NO" />
  </SESSIONCONFIG>

  <!-- ===================================================================== -->
  <!-- MAPPING STATISTICS AND DOCUMENTATION                                 -->
  <!-- ===================================================================== -->
  <MAPSTATS>
    <TOTALSTEP>9</TOTALSTEP>
    <TOTALSOURCES>2</TOTALSOURCES>
    <TOTALTARGETS>1</TOTALTARGETS>
    <TOTALEXPRESSIONS>3</TOTALEXPRESSIONS>
    <TOTALJOINS>1</TOTALJOINS>
    <TOTALFILTERS>1</FILTERS>
    <TOTALSEQUENCES>1</TOTALSEQUENCES>
    <TOTALUPDATESTRATEGIES>1</TOTALUPDATESTRATEGIES>
    <EXPECTEDTHROUGHPUT>10000-50000 rows/hour depending on change volume</EXPECTEDTHROUGHPUT>
    <EXPECTEDRECORDSPERLOAD>
      <STATISTIC NAME="New Applications" VALUE="200-500 inserts" />
      <STATISTIC NAME="Status Changes" VALUE="500-1000 insert+update pairs" />
      <STATISTIC NAME="Unchanged Records" VALUE="Filtered (no output)" />
    </EXPECTEDRECORDSPERLOAD>
  </MAPSTATS>

</MAPPING>
