<?xml version="1.0" encoding="UTF-8"?>
<!--
================================================================================
INFORMATICA POWERCENTER MAPPING EXPORT
Stage 6 of 6 — Mortgage Loan E2E Batch Pipeline
================================================================================
MAPPING NAME: m_HMDA_REGULATORY_REPORT
COMPLEXITY: MEDIUM | STACK: Python (Pandas)
TARGET PLATFORM: Snowflake + Oracle LOS + Flat File Output

PURPOSE:
  Final aggregation stage of the mortgage pricing and lending pipeline.
  Joins three source data sets (priced loans, current loan status, borrower 
  demographics), derives HMDA (Home Mortgage Disclosure Act) regulatory 
  compliance fields, aggregates metrics by census tract and action type, 
  sorts for regulatory filing requirements, and outputs fixed-format 
  pipe-delimited flat file for regulatory submission.

REGULATORY CONTEXT:
  This mapping implements HMDA reporting requirements per 12 CFR 1003.
  Derived fields include action type codes (1=Originated, 2=Approved Not 
  Accepted, 3=Denied, 4=Withdrawn, 5=Incomplete), loan purpose codes,
  property type codes, HOEPA status, and rate spread calculations.

DATA FLOW:
  SQ_PRICED_LOANS (Snowflake)
    └─> JNR_LOANS_STATUS
           └─> JNR_LOANS_DEMOGRAPHICS
                 └─> EXP_HMDA_FIELDS
                       └─> AGG_GEOGRAPHIC_SUMMARY
                             └─> SRT_BY_GEOGRAPHY
                                   └─> TGT_HMDA_REPORT_FILE (Flat File)

EXPECTED VOLUME: 1M-5M loan records per load cycle
INCREMENTAL: Yes (filtered by $$LOAD_DATE)
OUTPUT FREQUENCY: Monthly filing cycles aligned to $$REPORT_DATE

NOTES:
  - Uses Master Outer joins to preserve all pricing data even if status/demo missing
  - HOEPA threshold: APR - Offered Rate > 6.5%
  - Rate spread threshold: APR - Offered Rate > 1.5%
  - Income denominator: 1000 (for thousands display)
  - Output file uses pipe (|) delimiter with fixed record format
  - Aggregation prevents row-level PII in final output (compliance)
================================================================================
-->
<MAPPING>
  <HEADER>
    <NAME>m_HMDA_REGULATORY_REPORT</NAME>
    <DESCRIPTION>HMDA Regulatory Reporting Aggregation and File Export</DESCRIPTION>
    <CREATEDDATE>2026-03-01</CREATEDDATE>
    <MODIFIEDDATE>2026-03-01</MODIFIEDDATE>
    <VERSION>1.0.0</VERSION>
    <CODEPAGE>UTF-8</CODEPAGE>
    <MAPPINGTYPE>TRANSFORMATION</MAPPINGTYPE>
  </HEADER>

  <!-- ====================================================================
       PARAMETER AND VARIABLE DEFINITIONS
       ==================================================================== -->
  <PARAMETER NAME="$$SRC_CONNECTION" TYPE="STRING" DEFAULT="SNOWFLAKE_PROD">
    <DESCRIPTION>Snowflake source system connection string</DESCRIPTION>
  </PARAMETER>
  <PARAMETER NAME="$$LOS_CONNECTION" TYPE="STRING" DEFAULT="ORACLE_LOS_PROD">
    <DESCRIPTION>Oracle Loan Origination System connection string</DESCRIPTION>
  </PARAMETER>
  <PARAMETER NAME="$$REPORT_OUTPUT_DIR" TYPE="STRING" DEFAULT="/data/regulatory/hmda_output">
    <DESCRIPTION>Output directory for HMDA flat file export</DESCRIPTION>
  </PARAMETER>
  <PARAMETER NAME="$$REPORT_DATE" TYPE="DATE" DEFAULT="2026-02-28">
    <DESCRIPTION>Reporting cycle end date (month-end)</DESCRIPTION>
  </PARAMETER>
  <PARAMETER NAME="$$FILING_YEAR" TYPE="STRING" DEFAULT="2026">
    <DESCRIPTION>Calendar year for HMDA filing</DESCRIPTION>
  </PARAMETER>
  <PARAMETER NAME="$$LOAD_DATE" TYPE="DATE" DEFAULT="2026-02-28">
    <DESCRIPTION>Incremental load date filter</DESCRIPTION>
  </PARAMETER>
  <PARAMETER NAME="$$ENV" TYPE="STRING" DEFAULT="PROD">
    <DESCRIPTION>Environment identifier (DEV, QA, PROD)</DESCRIPTION>
  </PARAMETER>

  <!-- ====================================================================
       SOURCE DEFINITIONS
       ==================================================================== -->
  <SOURCE NAME="TGT_PRICED_LOANS" TYPE="RELATIONAL" DATABASETYPE="SNOWFLAKE">
    <CONNECTION>$$SRC_CONNECTION</CONNECTION>
    <SCHEMA>PUBLIC</SCHEMA>
    <TABLE>TGT_PRICED_LOANS</TABLE>
    <SOURCEFIELD NAME="APPLICATION_ID" DATATYPE="STRING" LENGTH="20"/>
    <SOURCEFIELD NAME="LOAN_AMOUNT" DATATYPE="DECIMAL" PRECISION="15" SCALE="2"/>
    <SOURCEFIELD NAME="LOAN_TYPE" DATATYPE="STRING" LENGTH="20"/>
    <SOURCEFIELD NAME="LOAN_TERM_MONTHS" DATATYPE="INTEGER"/>
    <SOURCEFIELD NAME="OCCUPANCY_TYPE" DATATYPE="STRING" LENGTH="20"/>
    <SOURCEFIELD NAME="PROPERTY_STATE" DATATYPE="STRING" LENGTH="2"/>
    <SOURCEFIELD NAME="BUREAU_SCORE" DATATYPE="INTEGER"/>
    <SOURCEFIELD NAME="CREDIT_TIER" DATATYPE="STRING" LENGTH="5"/>
    <SOURCEFIELD NAME="ACTUAL_LTV" DATATYPE="DECIMAL" PRECISION="5" SCALE="2"/>
    <SOURCEFIELD NAME="DTI_RATIO" DATATYPE="DECIMAL" PRECISION="5" SCALE="2"/>
    <SOURCEFIELD NAME="OFFERED_RATE" DATATYPE="DECIMAL" PRECISION="5" SCALE="3"/>
    <SOURCEFIELD NAME="APR" DATATYPE="DECIMAL" PRECISION="5" SCALE="3"/>
    <SOURCEFIELD NAME="MONTHLY_PAYMENT" DATATYPE="DECIMAL" PRECISION="10" SCALE="2"/>
    <SOURCEFIELD NAME="TOTAL_CLOSING_COSTS" DATATYPE="DECIMAL" PRECISION="10" SCALE="2"/>
    <SOURCEFIELD NAME="REQUIRES_PMI" DATATYPE="STRING" LENGTH="1"/>
    <SOURCEFIELD NAME="IS_REFI" DATATYPE="STRING" LENGTH="1"/>
    <SOURCEFIELD NAME="PRICING_DATE" DATATYPE="DATE"/>
    <SOURCEFIELD NAME="LOAN_OFFICER_ID" DATATYPE="STRING" LENGTH="20"/>
  </SOURCE>

  <SOURCE NAME="DIM_LOAN_STATUS" TYPE="RELATIONAL" DATABASETYPE="SNOWFLAKE">
    <CONNECTION>$$SRC_CONNECTION</CONNECTION>
    <SCHEMA>PUBLIC</SCHEMA>
    <TABLE>DIM_LOAN_STATUS</TABLE>
    <SOURCEFIELD NAME="APPLICATION_ID" DATATYPE="STRING" LENGTH="20"/>
    <SOURCEFIELD NAME="LOAN_STATUS" DATATYPE="STRING" LENGTH="20"/>
    <SOURCEFIELD NAME="STATUS_DATE" DATATYPE="DATE"/>
    <SOURCEFIELD NAME="OUTSTANDING_BALANCE" DATATYPE="DECIMAL" PRECISION="15" SCALE="2"/>
    <SOURCEFIELD NAME="DAYS_PAST_DUE" DATATYPE="INTEGER"/>
    <SOURCEFIELD NAME="IS_CURRENT" DATATYPE="STRING" LENGTH="1"/>
  </SOURCE>

  <SOURCE NAME="BORROWER_DEMOGRAPHICS" TYPE="RELATIONAL" DATABASETYPE="ORACLE">
    <CONNECTION>$$LOS_CONNECTION</CONNECTION>
    <SCHEMA>LENDING</SCHEMA>
    <TABLE>BORROWER_DEMOGRAPHICS</TABLE>
    <SOURCEFIELD NAME="APPLICATION_ID" DATATYPE="STRING" LENGTH="20"/>
    <SOURCEFIELD NAME="BORROWER_ETHNICITY" DATATYPE="STRING" LENGTH="2"/>
    <SOURCEFIELD NAME="BORROWER_RACE" DATATYPE="STRING" LENGTH="2"/>
    <SOURCEFIELD NAME="BORROWER_SEX" DATATYPE="STRING" LENGTH="1"/>
    <SOURCEFIELD NAME="BORROWER_AGE" DATATYPE="INTEGER"/>
    <SOURCEFIELD NAME="CO_BORROWER_ETHNICITY" DATATYPE="STRING" LENGTH="2"/>
    <SOURCEFIELD NAME="CO_BORROWER_RACE" DATATYPE="STRING" LENGTH="2"/>
    <SOURCEFIELD NAME="ANNUAL_INCOME" DATATYPE="DECIMAL" PRECISION="12" SCALE="2"/>
    <SOURCEFIELD NAME="CENSUS_TRACT" DATATYPE="STRING" LENGTH="12"/>
    <SOURCEFIELD NAME="COUNTY_CODE" DATATYPE="STRING" LENGTH="5"/>
    <SOURCEFIELD NAME="MSA_CODE" DATATYPE="STRING" LENGTH="5"/>
    <SOURCEFIELD NAME="PROPERTY_TYPE" DATATYPE="STRING" LENGTH="2"/>
  </SOURCE>

  <!-- ====================================================================
       TRANSFORMATION: SQ_PRICED_LOANS (Source Qualifier)
       Filter: PRICING_DATE = $$LOAD_DATE
       ==================================================================== -->
  <TRANSFORMATION NAME="SQ_PRICED_LOANS" TYPE="SOURCE_QUALIFIER">
    <DESCRIPTION>Filter priced loans for current load cycle</DESCRIPTION>
    <SOURCE_REFERENCE>TGT_PRICED_LOANS</SOURCE_REFERENCE>
    <SQL_OVERRIDE>
      <![CDATA[
SELECT
    APPLICATION_ID,
    LOAN_AMOUNT,
    LOAN_TYPE,
    LOAN_TERM_MONTHS,
    OCCUPANCY_TYPE,
    PROPERTY_STATE,
    BUREAU_SCORE,
    CREDIT_TIER,
    ACTUAL_LTV,
    DTI_RATIO,
    OFFERED_RATE,
    APR,
    MONTHLY_PAYMENT,
    TOTAL_CLOSING_COSTS,
    REQUIRES_PMI,
    IS_REFI,
    PRICING_DATE,
    LOAN_OFFICER_ID
FROM TGT_PRICED_LOANS
WHERE PRICING_DATE = '$$LOAD_DATE'
ORDER BY APPLICATION_ID
      ]]>
    </SQL_OVERRIDE>
    <OUTPUTPORT NAME="APPLICATION_ID" DATATYPE="STRING" LENGTH="20"/>
    <OUTPUTPORT NAME="LOAN_AMOUNT" DATATYPE="DECIMAL" PRECISION="15" SCALE="2"/>
    <OUTPUTPORT NAME="LOAN_TYPE" DATATYPE="STRING" LENGTH="20"/>
    <OUTPUTPORT NAME="LOAN_TERM_MONTHS" DATATYPE="INTEGER"/>
    <OUTPUTPORT NAME="OCCUPANCY_TYPE" DATATYPE="STRING" LENGTH="20"/>
    <OUTPUTPORT NAME="PROPERTY_STATE" DATATYPE="STRING" LENGTH="2"/>
    <OUTPUTPORT NAME="BUREAU_SCORE" DATATYPE="INTEGER"/>
    <OUTPUTPORT NAME="CREDIT_TIER" DATATYPE="STRING" LENGTH="5"/>
    <OUTPUTPORT NAME="ACTUAL_LTV" DATATYPE="DECIMAL" PRECISION="5" SCALE="2"/>
    <OUTPUTPORT NAME="DTI_RATIO" DATATYPE="DECIMAL" PRECISION="5" SCALE="2"/>
    <OUTPUTPORT NAME="OFFERED_RATE" DATATYPE="DECIMAL" PRECISION="5" SCALE="3"/>
    <OUTPUTPORT NAME="APR" DATATYPE="DECIMAL" PRECISION="5" SCALE="3"/>
    <OUTPUTPORT NAME="MONTHLY_PAYMENT" DATATYPE="DECIMAL" PRECISION="10" SCALE="2"/>
    <OUTPUTPORT NAME="TOTAL_CLOSING_COSTS" DATATYPE="DECIMAL" PRECISION="10" SCALE="2"/>
    <OUTPUTPORT NAME="REQUIRES_PMI" DATATYPE="STRING" LENGTH="1"/>
    <OUTPUTPORT NAME="IS_REFI" DATATYPE="STRING" LENGTH="1"/>
    <OUTPUTPORT NAME="PRICING_DATE" DATATYPE="DATE"/>
    <OUTPUTPORT NAME="LOAN_OFFICER_ID" DATATYPE="STRING" LENGTH="20"/>
  </TRANSFORMATION>

  <!-- ====================================================================
       TRANSFORMATION: SQ_DIM_LOAN_STATUS (Source Qualifier)
       Filter: IS_CURRENT='Y' AND STATUS_DATE = $$LOAD_DATE
       ==================================================================== -->
  <TRANSFORMATION NAME="SQ_DIM_LOAN_STATUS" TYPE="SOURCE_QUALIFIER">
    <DESCRIPTION>Filter current loan status records for load date</DESCRIPTION>
    <SOURCE_REFERENCE>DIM_LOAN_STATUS</SOURCE_REFERENCE>
    <SQL_OVERRIDE>
      <![CDATA[
SELECT
    APPLICATION_ID,
    LOAN_STATUS,
    STATUS_DATE,
    OUTSTANDING_BALANCE,
    DAYS_PAST_DUE,
    IS_CURRENT
FROM DIM_LOAN_STATUS
WHERE IS_CURRENT = 'Y'
  AND STATUS_DATE = '$$LOAD_DATE'
ORDER BY APPLICATION_ID
      ]]>
    </SQL_OVERRIDE>
    <OUTPUTPORT NAME="APPLICATION_ID" DATATYPE="STRING" LENGTH="20"/>
    <OUTPUTPORT NAME="LOAN_STATUS" DATATYPE="STRING" LENGTH="20"/>
    <OUTPUTPORT NAME="STATUS_DATE" DATATYPE="DATE"/>
    <OUTPUTPORT NAME="OUTSTANDING_BALANCE" DATATYPE="DECIMAL" PRECISION="15" SCALE="2"/>
    <OUTPUTPORT NAME="DAYS_PAST_DUE" DATATYPE="INTEGER"/>
    <OUTPUTPORT NAME="IS_CURRENT" DATATYPE="STRING" LENGTH="1"/>
  </TRANSFORMATION>

  <!-- ====================================================================
       TRANSFORMATION: SQ_BORROWER_DEMOGRAPHICS (Source Qualifier)
       No filtering — all current borrower records
       ==================================================================== -->
  <TRANSFORMATION NAME="SQ_BORROWER_DEMOGRAPHICS" TYPE="SOURCE_QUALIFIER">
    <DESCRIPTION>Load all borrower demographic records</DESCRIPTION>
    <SOURCE_REFERENCE>BORROWER_DEMOGRAPHICS</SOURCE_REFERENCE>
    <OUTPUTPORT NAME="APPLICATION_ID" DATATYPE="STRING" LENGTH="20"/>
    <OUTPUTPORT NAME="BORROWER_ETHNICITY" DATATYPE="STRING" LENGTH="2"/>
    <OUTPUTPORT NAME="BORROWER_RACE" DATATYPE="STRING" LENGTH="2"/>
    <OUTPUTPORT NAME="BORROWER_SEX" DATATYPE="STRING" LENGTH="1"/>
    <OUTPUTPORT NAME="BORROWER_AGE" DATATYPE="INTEGER"/>
    <OUTPUTPORT NAME="CO_BORROWER_ETHNICITY" DATATYPE="STRING" LENGTH="2"/>
    <OUTPUTPORT NAME="CO_BORROWER_RACE" DATATYPE="STRING" LENGTH="2"/>
    <OUTPUTPORT NAME="ANNUAL_INCOME" DATATYPE="DECIMAL" PRECISION="12" SCALE="2"/>
    <OUTPUTPORT NAME="CENSUS_TRACT" DATATYPE="STRING" LENGTH="12"/>
    <OUTPUTPORT NAME="COUNTY_CODE" DATATYPE="STRING" LENGTH="5"/>
    <OUTPUTPORT NAME="MSA_CODE" DATATYPE="STRING" LENGTH="5"/>
    <OUTPUTPORT NAME="PROPERTY_TYPE" DATATYPE="STRING" LENGTH="2"/>
  </TRANSFORMATION>

  <!-- ====================================================================
       TRANSFORMATION: JNR_LOANS_STATUS (Joiner)
       Master: SQ_PRICED_LOANS
       Detail: SQ_DIM_LOAN_STATUS
       Join Type: Master Outer (preserve all priced loans)
       Join Condition: APPLICATION_ID = APPLICATION_ID
       ==================================================================== -->
  <TRANSFORMATION NAME="JNR_LOANS_STATUS" TYPE="JOINER">
    <DESCRIPTION>Join priced loans with current loan status (Master Outer)</DESCRIPTION>
    <MASTER_SOURCE>SQ_PRICED_LOANS</MASTER_SOURCE>
    <DETAIL_SOURCE>SQ_DIM_LOAN_STATUS</DETAIL_SOURCE>
    <JOINTYPE>MASTER_OUTER</JOINTYPE>
    <JOINCONDITION>
      <LEFT_PORT>SQ_PRICED_LOANS.APPLICATION_ID</LEFT_PORT>
      <OPERATOR>EQ</OPERATOR>
      <RIGHT_PORT>SQ_DIM_LOAN_STATUS.APPLICATION_ID</RIGHT_PORT>
    </JOINCONDITION>
    <!-- Priced Loans Columns -->
    <OUTPUTPORT NAME="PL_APPLICATION_ID" DATATYPE="STRING" LENGTH="20" SOURCE="SQ_PRICED_LOANS.APPLICATION_ID"/>
    <OUTPUTPORT NAME="LOAN_AMOUNT" DATATYPE="DECIMAL" PRECISION="15" SCALE="2" SOURCE="SQ_PRICED_LOANS.LOAN_AMOUNT"/>
    <OUTPUTPORT NAME="LOAN_TYPE" DATATYPE="STRING" LENGTH="20" SOURCE="SQ_PRICED_LOANS.LOAN_TYPE"/>
    <OUTPUTPORT NAME="LOAN_TERM_MONTHS" DATATYPE="INTEGER" SOURCE="SQ_PRICED_LOANS.LOAN_TERM_MONTHS"/>
    <OUTPUTPORT NAME="OCCUPANCY_TYPE" DATATYPE="STRING" LENGTH="20" SOURCE="SQ_PRICED_LOANS.OCCUPANCY_TYPE"/>
    <OUTPUTPORT NAME="PROPERTY_STATE" DATATYPE="STRING" LENGTH="2" SOURCE="SQ_PRICED_LOANS.PROPERTY_STATE"/>
    <OUTPUTPORT NAME="BUREAU_SCORE" DATATYPE="INTEGER" SOURCE="SQ_PRICED_LOANS.BUREAU_SCORE"/>
    <OUTPUTPORT NAME="CREDIT_TIER" DATATYPE="STRING" LENGTH="5" SOURCE="SQ_PRICED_LOANS.CREDIT_TIER"/>
    <OUTPUTPORT NAME="ACTUAL_LTV" DATATYPE="DECIMAL" PRECISION="5" SCALE="2" SOURCE="SQ_PRICED_LOANS.ACTUAL_LTV"/>
    <OUTPUTPORT NAME="DTI_RATIO" DATATYPE="DECIMAL" PRECISION="5" SCALE="2" SOURCE="SQ_PRICED_LOANS.DTI_RATIO"/>
    <OUTPUTPORT NAME="OFFERED_RATE" DATATYPE="DECIMAL" PRECISION="5" SCALE="3" SOURCE="SQ_PRICED_LOANS.OFFERED_RATE"/>
    <OUTPUTPORT NAME="APR" DATATYPE="DECIMAL" PRECISION="5" SCALE="3" SOURCE="SQ_PRICED_LOANS.APR"/>
    <OUTPUTPORT NAME="MONTHLY_PAYMENT" DATATYPE="DECIMAL" PRECISION="10" SCALE="2" SOURCE="SQ_PRICED_LOANS.MONTHLY_PAYMENT"/>
    <OUTPUTPORT NAME="TOTAL_CLOSING_COSTS" DATATYPE="DECIMAL" PRECISION="10" SCALE="2" SOURCE="SQ_PRICED_LOANS.TOTAL_CLOSING_COSTS"/>
    <OUTPUTPORT NAME="REQUIRES_PMI" DATATYPE="STRING" LENGTH="1" SOURCE="SQ_PRICED_LOANS.REQUIRES_PMI"/>
    <OUTPUTPORT NAME="IS_REFI" DATATYPE="STRING" LENGTH="1" SOURCE="SQ_PRICED_LOANS.IS_REFI"/>
    <OUTPUTPORT NAME="PRICING_DATE" DATATYPE="DATE" SOURCE="SQ_PRICED_LOANS.PRICING_DATE"/>
    <OUTPUTPORT NAME="LOAN_OFFICER_ID" DATATYPE="STRING" LENGTH="20" SOURCE="SQ_PRICED_LOANS.LOAN_OFFICER_ID"/>
    <!-- Loan Status Columns -->
    <OUTPUTPORT NAME="LOAN_STATUS" DATATYPE="STRING" LENGTH="20" SOURCE="SQ_DIM_LOAN_STATUS.LOAN_STATUS" NULLABLE="Y"/>
    <OUTPUTPORT NAME="STATUS_DATE" DATATYPE="DATE" SOURCE="SQ_DIM_LOAN_STATUS.STATUS_DATE" NULLABLE="Y"/>
    <OUTPUTPORT NAME="OUTSTANDING_BALANCE" DATATYPE="DECIMAL" PRECISION="15" SCALE="2" SOURCE="SQ_DIM_LOAN_STATUS.OUTSTANDING_BALANCE" NULLABLE="Y"/>
    <OUTPUTPORT NAME="DAYS_PAST_DUE" DATATYPE="INTEGER" SOURCE="SQ_DIM_LOAN_STATUS.DAYS_PAST_DUE" NULLABLE="Y"/>
  </TRANSFORMATION>

  <!-- ====================================================================
       TRANSFORMATION: JNR_LOANS_DEMOGRAPHICS (Joiner)
       Master: JNR_LOANS_STATUS
       Detail: SQ_BORROWER_DEMOGRAPHICS
       Join Type: Master Outer (preserve all joined loans)
       Join Condition: APPLICATION_ID = APPLICATION_ID
       ==================================================================== -->
  <TRANSFORMATION NAME="JNR_LOANS_DEMOGRAPHICS" TYPE="JOINER">
    <DESCRIPTION>Join loans+status with borrower demographics (Master Outer)</DESCRIPTION>
    <MASTER_SOURCE>JNR_LOANS_STATUS</MASTER_SOURCE>
    <DETAIL_SOURCE>SQ_BORROWER_DEMOGRAPHICS</DETAIL_SOURCE>
    <JOINTYPE>MASTER_OUTER</JOINTYPE>
    <JOINCONDITION>
      <LEFT_PORT>JNR_LOANS_STATUS.PL_APPLICATION_ID</LEFT_PORT>
      <OPERATOR>EQ</OPERATOR>
      <RIGHT_PORT>SQ_BORROWER_DEMOGRAPHICS.APPLICATION_ID</RIGHT_PORT>
    </JOINCONDITION>
    <!-- Loans + Status Columns (passthrough) -->
    <OUTPUTPORT NAME="APPLICATION_ID" DATATYPE="STRING" LENGTH="20" SOURCE="JNR_LOANS_STATUS.PL_APPLICATION_ID"/>
    <OUTPUTPORT NAME="LOAN_AMOUNT" DATATYPE="DECIMAL" PRECISION="15" SCALE="2" SOURCE="JNR_LOANS_STATUS.LOAN_AMOUNT"/>
    <OUTPUTPORT NAME="LOAN_TYPE" DATATYPE="STRING" LENGTH="20" SOURCE="JNR_LOANS_STATUS.LOAN_TYPE"/>
    <OUTPUTPORT NAME="LOAN_TERM_MONTHS" DATATYPE="INTEGER" SOURCE="JNR_LOANS_STATUS.LOAN_TERM_MONTHS"/>
    <OUTPUTPORT NAME="OCCUPANCY_TYPE" DATATYPE="STRING" LENGTH="20" SOURCE="JNR_LOANS_STATUS.OCCUPANCY_TYPE"/>
    <OUTPUTPORT NAME="PROPERTY_STATE" DATATYPE="STRING" LENGTH="2" SOURCE="JNR_LOANS_STATUS.PROPERTY_STATE"/>
    <OUTPUTPORT NAME="BUREAU_SCORE" DATATYPE="INTEGER" SOURCE="JNR_LOANS_STATUS.BUREAU_SCORE"/>
    <OUTPUTPORT NAME="CREDIT_TIER" DATATYPE="STRING" LENGTH="5" SOURCE="JNR_LOANS_STATUS.CREDIT_TIER"/>
    <OUTPUTPORT NAME="ACTUAL_LTV" DATATYPE="DECIMAL" PRECISION="5" SCALE="2" SOURCE="JNR_LOANS_STATUS.ACTUAL_LTV"/>
    <OUTPUTPORT NAME="DTI_RATIO" DATATYPE="DECIMAL" PRECISION="5" SCALE="2" SOURCE="JNR_LOANS_STATUS.DTI_RATIO"/>
    <OUTPUTPORT NAME="OFFERED_RATE" DATATYPE="DECIMAL" PRECISION="5" SCALE="3" SOURCE="JNR_LOANS_STATUS.OFFERED_RATE"/>
    <OUTPUTPORT NAME="APR" DATATYPE="DECIMAL" PRECISION="5" SCALE="3" SOURCE="JNR_LOANS_STATUS.APR"/>
    <OUTPUTPORT NAME="MONTHLY_PAYMENT" DATATYPE="DECIMAL" PRECISION="10" SCALE="2" SOURCE="JNR_LOANS_STATUS.MONTHLY_PAYMENT"/>
    <OUTPUTPORT NAME="TOTAL_CLOSING_COSTS" DATATYPE="DECIMAL" PRECISION="10" SCALE="2" SOURCE="JNR_LOANS_STATUS.TOTAL_CLOSING_COSTS"/>
    <OUTPUTPORT NAME="REQUIRES_PMI" DATATYPE="STRING" LENGTH="1" SOURCE="JNR_LOANS_STATUS.REQUIRES_PMI"/>
    <OUTPUTPORT NAME="IS_REFI" DATATYPE="STRING" LENGTH="1" SOURCE="JNR_LOANS_STATUS.IS_REFI"/>
    <OUTPUTPORT NAME="PRICING_DATE" DATATYPE="DATE" SOURCE="JNR_LOANS_STATUS.PRICING_DATE"/>
    <OUTPUTPORT NAME="LOAN_OFFICER_ID" DATATYPE="STRING" LENGTH="20" SOURCE="JNR_LOANS_STATUS.LOAN_OFFICER_ID"/>
    <OUTPUTPORT NAME="LOAN_STATUS" DATATYPE="STRING" LENGTH="20" SOURCE="JNR_LOANS_STATUS.LOAN_STATUS" NULLABLE="Y"/>
    <OUTPUTPORT NAME="STATUS_DATE" DATATYPE="DATE" SOURCE="JNR_LOANS_STATUS.STATUS_DATE" NULLABLE="Y"/>
    <OUTPUTPORT NAME="OUTSTANDING_BALANCE" DATATYPE="DECIMAL" PRECISION="15" SCALE="2" SOURCE="JNR_LOANS_STATUS.OUTSTANDING_BALANCE" NULLABLE="Y"/>
    <OUTPUTPORT NAME="DAYS_PAST_DUE" DATATYPE="INTEGER" SOURCE="JNR_LOANS_STATUS.DAYS_PAST_DUE" NULLABLE="Y"/>
    <!-- Demographics Columns -->
    <OUTPUTPORT NAME="BORROWER_ETHNICITY" DATATYPE="STRING" LENGTH="2" SOURCE="SQ_BORROWER_DEMOGRAPHICS.BORROWER_ETHNICITY" NULLABLE="Y"/>
    <OUTPUTPORT NAME="BORROWER_RACE" DATATYPE="STRING" LENGTH="2" SOURCE="SQ_BORROWER_DEMOGRAPHICS.BORROWER_RACE" NULLABLE="Y"/>
    <OUTPUTPORT NAME="BORROWER_SEX" DATATYPE="STRING" LENGTH="1" SOURCE="SQ_BORROWER_DEMOGRAPHICS.BORROWER_SEX" NULLABLE="Y"/>
    <OUTPUTPORT NAME="BORROWER_AGE" DATATYPE="INTEGER" SOURCE="SQ_BORROWER_DEMOGRAPHICS.BORROWER_AGE" NULLABLE="Y"/>
    <OUTPUTPORT NAME="CO_BORROWER_ETHNICITY" DATATYPE="STRING" LENGTH="2" SOURCE="SQ_BORROWER_DEMOGRAPHICS.CO_BORROWER_ETHNICITY" NULLABLE="Y"/>
    <OUTPUTPORT NAME="CO_BORROWER_RACE" DATATYPE="STRING" LENGTH="2" SOURCE="SQ_BORROWER_DEMOGRAPHICS.CO_BORROWER_RACE" NULLABLE="Y"/>
    <OUTPUTPORT NAME="ANNUAL_INCOME" DATATYPE="DECIMAL" PRECISION="12" SCALE="2" SOURCE="SQ_BORROWER_DEMOGRAPHICS.ANNUAL_INCOME" NULLABLE="Y"/>
    <OUTPUTPORT NAME="CENSUS_TRACT" DATATYPE="STRING" LENGTH="12" SOURCE="SQ_BORROWER_DEMOGRAPHICS.CENSUS_TRACT" NULLABLE="Y"/>
    <OUTPUTPORT NAME="COUNTY_CODE" DATATYPE="STRING" LENGTH="5" SOURCE="SQ_BORROWER_DEMOGRAPHICS.COUNTY_CODE" NULLABLE="Y"/>
    <OUTPUTPORT NAME="MSA_CODE" DATATYPE="STRING" LENGTH="5" SOURCE="SQ_BORROWER_DEMOGRAPHICS.MSA_CODE" NULLABLE="Y"/>
    <OUTPUTPORT NAME="PROPERTY_TYPE" DATATYPE="STRING" LENGTH="2" SOURCE="SQ_BORROWER_DEMOGRAPHICS.PROPERTY_TYPE" NULLABLE="Y"/>
  </TRANSFORMATION>

  <!-- ====================================================================
       TRANSFORMATION: EXP_HMDA_FIELDS (Expression)
       Derives all HMDA regulatory compliance fields
       ==================================================================== -->
  <TRANSFORMATION NAME="EXP_HMDA_FIELDS" TYPE="EXPRESSION">
    <DESCRIPTION>Derive HMDA regulatory action types, loan purpose codes, property types, income scaling, rate spreads, and HOEPA status</DESCRIPTION>
    <INPUTPORT NAME="APPLICATION_ID" DATATYPE="STRING" LENGTH="20"/>
    <INPUTPORT NAME="LOAN_AMOUNT" DATATYPE="DECIMAL" PRECISION="15" SCALE="2"/>
    <INPUTPORT NAME="LOAN_TYPE" DATATYPE="STRING" LENGTH="20"/>
    <INPUTPORT NAME="LOAN_TERM_MONTHS" DATATYPE="INTEGER"/>
    <INPUTPORT NAME="OCCUPANCY_TYPE" DATATYPE="STRING" LENGTH="20"/>
    <INPUTPORT NAME="PROPERTY_STATE" DATATYPE="STRING" LENGTH="2"/>
    <INPUTPORT NAME="BUREAU_SCORE" DATATYPE="INTEGER"/>
    <INPUTPORT NAME="CREDIT_TIER" DATATYPE="STRING" LENGTH="5"/>
    <INPUTPORT NAME="ACTUAL_LTV" DATATYPE="DECIMAL" PRECISION="5" SCALE="2"/>
    <INPUTPORT NAME="DTI_RATIO" DATATYPE="DECIMAL" PRECISION="5" SCALE="2"/>
    <INPUTPORT NAME="OFFERED_RATE" DATATYPE="DECIMAL" PRECISION="5" SCALE="3"/>
    <INPUTPORT NAME="APR" DATATYPE="DECIMAL" PRECISION="5" SCALE="3"/>
    <INPUTPORT NAME="MONTHLY_PAYMENT" DATATYPE="DECIMAL" PRECISION="10" SCALE="2"/>
    <INPUTPORT NAME="TOTAL_CLOSING_COSTS" DATATYPE="DECIMAL" PRECISION="10" SCALE="2"/>
    <INPUTPORT NAME="REQUIRES_PMI" DATATYPE="STRING" LENGTH="1"/>
    <INPUTPORT NAME="IS_REFI" DATATYPE="STRING" LENGTH="1"/>
    <INPUTPORT NAME="PRICING_DATE" DATATYPE="DATE"/>
    <INPUTPORT NAME="LOAN_OFFICER_ID" DATATYPE="STRING" LENGTH="20"/>
    <INPUTPORT NAME="LOAN_STATUS" DATATYPE="STRING" LENGTH="20" NULLABLE="Y"/>
    <INPUTPORT NAME="STATUS_DATE" DATATYPE="DATE" NULLABLE="Y"/>
    <INPUTPORT NAME="OUTSTANDING_BALANCE" DATATYPE="DECIMAL" PRECISION="15" SCALE="2" NULLABLE="Y"/>
    <INPUTPORT NAME="DAYS_PAST_DUE" DATATYPE="INTEGER" NULLABLE="Y"/>
    <INPUTPORT NAME="BORROWER_ETHNICITY" DATATYPE="STRING" LENGTH="2" NULLABLE="Y"/>
    <INPUTPORT NAME="BORROWER_RACE" DATATYPE="STRING" LENGTH="2" NULLABLE="Y"/>
    <INPUTPORT NAME="BORROWER_SEX" DATATYPE="STRING" LENGTH="1" NULLABLE="Y"/>
    <INPUTPORT NAME="BORROWER_AGE" DATATYPE="INTEGER" NULLABLE="Y"/>
    <INPUTPORT NAME="CO_BORROWER_ETHNICITY" DATATYPE="STRING" LENGTH="2" NULLABLE="Y"/>
    <INPUTPORT NAME="CO_BORROWER_RACE" DATATYPE="STRING" LENGTH="2" NULLABLE="Y"/>
    <INPUTPORT NAME="ANNUAL_INCOME" DATATYPE="DECIMAL" PRECISION="12" SCALE="2" NULLABLE="Y"/>
    <INPUTPORT NAME="CENSUS_TRACT" DATATYPE="STRING" LENGTH="12" NULLABLE="Y"/>
    <INPUTPORT NAME="COUNTY_CODE" DATATYPE="STRING" LENGTH="5" NULLABLE="Y"/>
    <INPUTPORT NAME="MSA_CODE" DATATYPE="STRING" LENGTH="5" NULLABLE="Y"/>
    <INPUTPORT NAME="PROPERTY_TYPE" DATATYPE="STRING" LENGTH="2" NULLABLE="Y"/>

    <!-- Passthrough Columns -->
    <OUTPUTPORT NAME="APPLICATION_ID" DATATYPE="STRING" LENGTH="20" EXPRESSION="APPLICATION_ID"/>
    <OUTPUTPORT NAME="LOAN_AMOUNT" DATATYPE="DECIMAL" PRECISION="15" SCALE="2" EXPRESSION="LOAN_AMOUNT"/>
    <OUTPUTPORT NAME="PROPERTY_STATE" DATATYPE="STRING" LENGTH="2" EXPRESSION="PROPERTY_STATE"/>
    <OUTPUTPORT NAME="BUREAU_SCORE" DATATYPE="INTEGER" EXPRESSION="BUREAU_SCORE"/>
    <OUTPUTPORT NAME="APR" DATATYPE="DECIMAL" PRECISION="5" SCALE="3" EXPRESSION="APR"/>
    <OUTPUTPORT NAME="CENSUS_TRACT" DATATYPE="STRING" LENGTH="12" EXPRESSION="CENSUS_TRACT"/>
    <OUTPUTPORT NAME="COUNTY_CODE" DATATYPE="STRING" LENGTH="5" EXPRESSION="COUNTY_CODE"/>
    <OUTPUTPORT NAME="MSA_CODE" DATATYPE="STRING" LENGTH="5" EXPRESSION="MSA_CODE"/>

    <!-- HMDA Action Type Code (1=Originated, 2=Approved Not Accepted, 3=Denied, 4=Withdrawn, 5=Incomplete) -->
    <OUTPUTPORT NAME="HMDA_ACTION_TYPE" DATATYPE="STRING" LENGTH="1" EXPRESSION="IIF(LOAN_STATUS = 'FUNDED', '1', IIF(LOAN_STATUS = 'APPROVED', '2', IIF(LOAN_STATUS = 'DECLINED', '3', IIF(LOAN_STATUS = 'CANCELLED', '4', '5'))))"/>

    <!-- HMDA Loan Purpose Code (1=Purchase, 31=Refinance, 4=HELOC) -->
    <OUTPUTPORT NAME="HMDA_LOAN_PURPOSE" DATATYPE="STRING" LENGTH="2" EXPRESSION="IIF(IS_REFI = 'Y', '31', IIF(LOAN_TYPE = 'PURCHASE', '1', IIF(LOAN_TYPE = 'HELOC', '4', '1')))"/>

    <!-- HMDA Property Type Code (1=Primary, 2=Secondary, 3=Investment) -->
    <OUTPUTPORT NAME="HMDA_PROPERTY_TYPE" DATATYPE="STRING" LENGTH="1" EXPRESSION="IIF(OCCUPANCY_TYPE = 'PRIMARY', '1', IIF(OCCUPANCY_TYPE = 'SECONDARY', '2', '3'))"/>

    <!-- Income in Thousands (for HMDA reporting scale) -->
    <OUTPUTPORT NAME="INCOME_THOUSANDS" DATATYPE="DECIMAL" PRECISION="10" SCALE="0" EXPRESSION="ROUND(ANNUAL_INCOME / 1000, 0)"/>

    <!-- Rate Spread Calculation (APR - Offered Rate; NA if &lt;= 1.5%) -->
    <OUTPUTPORT NAME="RATE_SPREAD" DATATYPE="STRING" LENGTH="10" EXPRESSION="IIF(APR - OFFERED_RATE > 1.5, TO_CHAR(APR - OFFERED_RATE, '99.99'), 'NA')"/>

    <!-- HOEPA Status (1=HOEPA if APR-Offered > 6.5%, else 3=Not HOEPA) -->
    <OUTPUTPORT NAME="HOEPA_STATUS" DATATYPE="STRING" LENGTH="1" EXPRESSION="IIF(APR - OFFERED_RATE > 6.5, '1', '3')"/>

    <!-- Filing Year from parameter -->
    <OUTPUTPORT NAME="FILING_YEAR" DATATYPE="STRING" LENGTH="4" EXPRESSION="'$$FILING_YEAR'"/>

    <!-- Report Date from parameter -->
    <OUTPUTPORT NAME="REPORT_DATE" DATATYPE="DATE" EXPRESSION="'$$REPORT_DATE'"/>
  </TRANSFORMATION>

  <!-- ====================================================================
       TRANSFORMATION: AGG_GEOGRAPHIC_SUMMARY (Aggregator)
       Group By: CENSUS_TRACT, COUNTY_CODE, MSA_CODE, HMDA_ACTION_TYPE,
                 HMDA_LOAN_PURPOSE, HMDA_PROPERTY_TYPE, PROPERTY_STATE, FILING_YEAR
       Aggregations: COUNT(*), SUM(LOAN_AMOUNT), AVG(BUREAU_SCORE), 
                     AVG(APR), AVG(INCOME_THOUSANDS)
       ==================================================================== -->
  <TRANSFORMATION NAME="AGG_GEOGRAPHIC_SUMMARY" TYPE="AGGREGATOR">
    <DESCRIPTION>Aggregate loan metrics by geographic and regulatory dimensions</DESCRIPTION>
    <GROUPBYPORT NAME="PROPERTY_STATE" DATATYPE="STRING" LENGTH="2"/>
    <GROUPBYPORT NAME="COUNTY_CODE" DATATYPE="STRING" LENGTH="5"/>
    <GROUPBYPORT NAME="CENSUS_TRACT" DATATYPE="STRING" LENGTH="12"/>
    <GROUPBYPORT NAME="MSA_CODE" DATATYPE="STRING" LENGTH="5"/>
    <GROUPBYPORT NAME="HMDA_ACTION_TYPE" DATATYPE="STRING" LENGTH="1"/>
    <GROUPBYPORT NAME="HMDA_LOAN_PURPOSE" DATATYPE="STRING" LENGTH="2"/>
    <GROUPBYPORT NAME="HMDA_PROPERTY_TYPE" DATATYPE="STRING" LENGTH="1"/>
    <GROUPBYPORT NAME="FILING_YEAR" DATATYPE="STRING" LENGTH="4"/>
    
    <AGGREGATEPORT NAME="LOAN_COUNT" DATATYPE="INTEGER" FUNCTION="COUNT" SOURCEPORT="APPLICATION_ID"/>
    <AGGREGATEPORT NAME="TOTAL_LOAN_AMOUNT" DATATYPE="DECIMAL" PRECISION="18" SCALE="2" FUNCTION="SUM" SOURCEPORT="LOAN_AMOUNT"/>
    <AGGREGATEPORT NAME="AVG_CREDIT_SCORE" DATATYPE="DECIMAL" PRECISION="10" SCALE="2" FUNCTION="AVG" SOURCEPORT="BUREAU_SCORE"/>
    <AGGREGATEPORT NAME="AVG_APR" DATATYPE="DECIMAL" PRECISION="5" SCALE="3" FUNCTION="AVG" SOURCEPORT="APR"/>
    <AGGREGATEPORT NAME="AVG_INCOME_THOUSANDS" DATATYPE="DECIMAL" PRECISION="10" SCALE="2" FUNCTION="AVG" SOURCEPORT="INCOME_THOUSANDS"/>
  </TRANSFORMATION>

  <!-- ====================================================================
       TRANSFORMATION: SRT_BY_GEOGRAPHY (Sorter)
       Sort Key: FILING_YEAR ASC, PROPERTY_STATE ASC, COUNTY_CODE ASC, 
                 CENSUS_TRACT ASC, HMDA_ACTION_TYPE ASC
       ==================================================================== -->
  <TRANSFORMATION NAME="SRT_BY_GEOGRAPHY" TYPE="SORTER">
    <DESCRIPTION>Sort aggregated records by filing year, geography, and action type for regulatory compliance</DESCRIPTION>
    <SORTKEY NAME="FILING_YEAR" ORDER="ASCENDING" DATATYPE="STRING" LENGTH="4"/>
    <SORTKEY NAME="PROPERTY_STATE" ORDER="ASCENDING" DATATYPE="STRING" LENGTH="2"/>
    <SORTKEY NAME="COUNTY_CODE" ORDER="ASCENDING" DATATYPE="STRING" LENGTH="5"/>
    <SORTKEY NAME="CENSUS_TRACT" ORDER="ASCENDING" DATATYPE="STRING" LENGTH="12"/>
    <SORTKEY NAME="HMDA_ACTION_TYPE" ORDER="ASCENDING" DATATYPE="STRING" LENGTH="1"/>
    
    <OUTPUTPORT NAME="PROPERTY_STATE" DATATYPE="STRING" LENGTH="2"/>
    <OUTPUTPORT NAME="COUNTY_CODE" DATATYPE="STRING" LENGTH="5"/>
    <OUTPUTPORT NAME="CENSUS_TRACT" DATATYPE="STRING" LENGTH="12"/>
    <OUTPUTPORT NAME="MSA_CODE" DATATYPE="STRING" LENGTH="5"/>
    <OUTPUTPORT NAME="HMDA_ACTION_TYPE" DATATYPE="STRING" LENGTH="1"/>
    <OUTPUTPORT NAME="HMDA_LOAN_PURPOSE" DATATYPE="STRING" LENGTH="2"/>
    <OUTPUTPORT NAME="HMDA_PROPERTY_TYPE" DATATYPE="STRING" LENGTH="1"/>
    <OUTPUTPORT NAME="FILING_YEAR" DATATYPE="STRING" LENGTH="4"/>
    <OUTPUTPORT NAME="LOAN_COUNT" DATATYPE="INTEGER"/>
    <OUTPUTPORT NAME="TOTAL_LOAN_AMOUNT" DATATYPE="DECIMAL" PRECISION="18" SCALE="2"/>
    <OUTPUTPORT NAME="AVG_CREDIT_SCORE" DATATYPE="DECIMAL" PRECISION="10" SCALE="2"/>
    <OUTPUTPORT NAME="AVG_APR" DATATYPE="DECIMAL" PRECISION="5" SCALE="3"/>
    <OUTPUTPORT NAME="AVG_INCOME_THOUSANDS" DATATYPE="DECIMAL" PRECISION="10" SCALE="2"/>
  </TRANSFORMATION>

  <!-- ====================================================================
       TARGET: TGT_HMDA_REPORT_FILE (Flat File)
       Format: Pipe-delimited (|)
       Output Path: $$REPORT_OUTPUT_DIR/HMDA_$$FILING_YEAR_$$REPORT_DATE.txt
       ==================================================================== -->
  <TARGET NAME="TGT_HMDA_REPORT_FILE" TYPE="FLAT_FILE" DATABASETYPE="FLAT FILE">
    <CONNECTION>$$REPORT_OUTPUT_DIR</CONNECTION>
    <FILENAME>HMDA_$$FILING_YEAR_$$REPORT_DATE.txt</FILENAME>
    <FILEFORMAT>DELIMITED</FILEFORMAT>
    <DELIMITER>|</DELIMITER>
    <CHARACTERSET>UTF-8</CHARACTERSET>
    <DESCRIPTION>HMDA Regulatory Report File (Aggregated, Sorted for Filing)</DESCRIPTION>
    
    <TARGETFIELD NAME="FILING_YEAR" DATATYPE="STRING" LENGTH="4" NULLABLE="N">
      <DESCRIPTION>Calendar year for HMDA filing (YYYY format)</DESCRIPTION>
    </TARGETFIELD>
    <TARGETFIELD NAME="PROPERTY_STATE" DATATYPE="STRING" LENGTH="2" NULLABLE="N">
      <DESCRIPTION>Two-letter state code</DESCRIPTION>
    </TARGETFIELD>
    <TARGETFIELD NAME="COUNTY_CODE" DATATYPE="STRING" LENGTH="5" NULLABLE="N">
      <DESCRIPTION>FIPS county code</DESCRIPTION>
    </TARGETFIELD>
    <TARGETFIELD NAME="CENSUS_TRACT" DATATYPE="STRING" LENGTH="12" NULLABLE="N">
      <DESCRIPTION>Census tract identifier (up to 12 chars for flexibility)</DESCRIPTION>
    </TARGETFIELD>
    <TARGETFIELD NAME="MSA_CODE" DATATYPE="STRING" LENGTH="5" NULLABLE="Y">
      <DESCRIPTION>Metropolitan Statistical Area code</DESCRIPTION>
    </TARGETFIELD>
    <TARGETFIELD NAME="HMDA_ACTION_TYPE" DATATYPE="STRING" LENGTH="1" NULLABLE="N">
      <DESCRIPTION>HMDA action type: 1=Originated, 2=Approved Not Accepted, 3=Denied, 4=Withdrawn, 5=Incomplete</DESCRIPTION>
    </TARGETFIELD>
    <TARGETFIELD NAME="HMDA_LOAN_PURPOSE" DATATYPE="STRING" LENGTH="2" NULLABLE="N">
      <DESCRIPTION>HMDA loan purpose: 1=Purchase, 31=Refinance, 4=HELOC, other=Home Improvement</DESCRIPTION>
    </TARGETFIELD>
    <TARGETFIELD NAME="HMDA_PROPERTY_TYPE" DATATYPE="STRING" LENGTH="1" NULLABLE="N">
      <DESCRIPTION>HMDA property type: 1=Primary Residence, 2=Secondary Residence, 3=Investment</DESCRIPTION>
    </TARGETFIELD>
    <TARGETFIELD NAME="LOAN_COUNT" DATATYPE="INTEGER" NULLABLE="N">
      <DESCRIPTION>Total count of loans in this geographic + action type aggregation</DESCRIPTION>
    </TARGETFIELD>
    <TARGETFIELD NAME="TOTAL_LOAN_AMOUNT" DATATYPE="DECIMAL" PRECISION="18" SCALE="2" NULLABLE="N">
      <DESCRIPTION>Sum of loan amounts (dollars)</DESCRIPTION>
    </TARGETFIELD>
    <TARGETFIELD NAME="AVG_CREDIT_SCORE" DATATYPE="DECIMAL" PRECISION="10" SCALE="2" NULLABLE="Y">
      <DESCRIPTION>Average bureau credit score (FICO-equivalent)</DESCRIPTION>
    </TARGETFIELD>
    <TARGETFIELD NAME="AVG_APR" DATATYPE="DECIMAL" PRECISION="5" SCALE="3" NULLABLE="Y">
      <DESCRIPTION>Average Annual Percentage Rate across loans</DESCRIPTION>
    </TARGETFIELD>
    <TARGETFIELD NAME="AVG_INCOME_THOUSANDS" DATATYPE="DECIMAL" PRECISION="10" SCALE="2" NULLABLE="Y">
      <DESCRIPTION>Average annual income (in thousands)</DESCRIPTION>
    </TARGETFIELD>
  </TARGET>

  <!-- ====================================================================
       DATA FLOW CONNECTORS
       ==================================================================== -->
  <CONNECTOR>
    <SOURCE_TRANSFORMATION>SQ_PRICED_LOANS</SOURCE_TRANSFORMATION>
    <TARGET_TRANSFORMATION>JNR_LOANS_STATUS</TARGET_TRANSFORMATION>
    <CONNECTION_TYPE>MASTER_INPUT</CONNECTION_TYPE>
  </CONNECTOR>

  <CONNECTOR>
    <SOURCE_TRANSFORMATION>SQ_DIM_LOAN_STATUS</SOURCE_TRANSFORMATION>
    <TARGET_TRANSFORMATION>JNR_LOANS_STATUS</TARGET_TRANSFORMATION>
    <CONNECTION_TYPE>DETAIL_INPUT</CONNECTION_TYPE>
  </CONNECTOR>

  <CONNECTOR>
    <SOURCE_TRANSFORMATION>JNR_LOANS_STATUS</SOURCE_TRANSFORMATION>
    <TARGET_TRANSFORMATION>JNR_LOANS_DEMOGRAPHICS</TARGET_TRANSFORMATION>
    <CONNECTION_TYPE>MASTER_INPUT</CONNECTION_TYPE>
  </CONNECTOR>

  <CONNECTOR>
    <SOURCE_TRANSFORMATION>SQ_BORROWER_DEMOGRAPHICS</SOURCE_TRANSFORMATION>
    <TARGET_TRANSFORMATION>JNR_LOANS_DEMOGRAPHICS</TARGET_TRANSFORMATION>
    <CONNECTION_TYPE>DETAIL_INPUT</CONNECTION_TYPE>
  </CONNECTOR>

  <CONNECTOR>
    <SOURCE_TRANSFORMATION>JNR_LOANS_DEMOGRAPHICS</SOURCE_TRANSFORMATION>
    <TARGET_TRANSFORMATION>EXP_HMDA_FIELDS</TARGET_TRANSFORMATION>
    <CONNECTION_TYPE>NORMAL</CONNECTION_TYPE>
  </CONNECTOR>

  <CONNECTOR>
    <SOURCE_TRANSFORMATION>EXP_HMDA_FIELDS</SOURCE_TRANSFORMATION>
    <TARGET_TRANSFORMATION>AGG_GEOGRAPHIC_SUMMARY</TARGET_TRANSFORMATION>
    <CONNECTION_TYPE>NORMAL</CONNECTION_TYPE>
  </CONNECTOR>

  <CONNECTOR>
    <SOURCE_TRANSFORMATION>AGG_GEOGRAPHIC_SUMMARY</SOURCE_TRANSFORMATION>
    <TARGET_TRANSFORMATION>SRT_BY_GEOGRAPHY</TARGET_TRANSFORMATION>
    <CONNECTION_TYPE>NORMAL</CONNECTION_TYPE>
  </CONNECTOR>

  <CONNECTOR>
    <SOURCE_TRANSFORMATION>SRT_BY_GEOGRAPHY</SOURCE_TRANSFORMATION>
    <TARGET_TABLE>TGT_HMDA_REPORT_FILE</TARGET_TABLE>
    <CONNECTION_TYPE>NORMAL</CONNECTION_TYPE>
  </CONNECTOR>

  <!-- ====================================================================
       MAPPING METADATA & EXECUTION OPTIONS
       ==================================================================== -->
  <MAPPING_OPTIONS>
    <OPTION NAME="COMMIT_INTERVAL" VALUE="10000"/>
    <OPTION NAME="ERRORHANDLING" VALUE="FAIL_ON_ERROR"/>
    <OPTION NAME="PRECISION" VALUE="DECIMAL"/>
    <OPTION NAME="INCREMENTAL_MODE" VALUE="LOAD_DATE_BASED"/>
  </MAPPING_OPTIONS>

  <!-- ====================================================================
       FOOTER: REVISION HISTORY & ANNOTATIONS
       ==================================================================== -->
  <REVISION>
    <VERSION>1.0.0</VERSION>
    <DATE>2026-03-01</DATE>
    <AUTHOR>Informatica Platform Admin</AUTHOR>
    <DESCRIPTION>Initial mapping for HMDA regulatory reporting pipeline (Stage 6 of 6)</DESCRIPTION>
    <NOTES>
      This mapping represents the final aggregation and regulatory output stage of the 
      mortgage loan E2E batch pipeline. It consolidates priced loans with status and 
      demographic data, applies HMDA compliance transformations, and produces a 
      standardized pipe-delimited output file for regulatory submission.

      Key regulatory compliance checkpoints:
      - HOEPA rate threshold (APR - Offered Rate &gt; 6.5%)
      - Rate spread disclosure threshold (APR - Offered Rate &gt; 1.5%)
      - HMDA action type coding per 12 CFR 1003.3
      - HMDA loan purpose coding per 12 CFR 1003
      - Geographic aggregation by census tract, county, and MSA
      - Aggregation removes row-level PII (individual borrower details)

      Expected volume: 1M-5M loan records per monthly load cycle.
      Dependencies: Must run after m_PRICE_LOANS and m_LOAN_STATUS_CURRENT mappings.
    </NOTES>
  </REVISION>

</MAPPING>
